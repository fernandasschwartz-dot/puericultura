<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Puericultura Dra Schwartz üçºüë∂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase (preencha firebaseConfig l√° embaixo) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <style>
    :root {
      --rosa1: #ff6f91;
      --rosa2: #ff4081;
      --rosa3: #ffb6c1;
      --rosa-claro: #ffe4f3;
      --bg: #fff8e1;
      --texto: #333;
      --card: #ffffff;
      --borda: #ffcdd2;

      --risk-habitual: #e8f5e9;
      --risk-inter: #fff8e1;
      --risk-alto: #ffebee;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--texto);
    }

    /* ========= TELA DE LOGIN ========= */

    #login-container {
      max-width: 380px;
      margin: 40px auto;
      padding: 24px 20px 28px;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      border: 1px solid #ffe0e0;
    }

    #login-container h2 {
      margin-top: 0;
      margin-bottom: 4px;
      text-align: center;
      color: #ff4081;
      font-size: 1.4rem;
    }

    #login-container p.subtitle {
      margin: 0 0 16px;
      text-align: center;
      font-size: 0.9rem;
      color: #666;
    }

    #login-container label {
      margin-top: 10px;
      display: block;
      font-size: 0.85rem;
      color: #555;
    }

    #login-container input[type="email"],
    #login-container input[type="password"] {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: #fafafa;
    }

    #login-container input[type="email"]:focus,
    #login-container input[type="password"]:focus {
      border-color: #ff4081;
      box-shadow: 0 0 0 2px rgba(255,64,129,0.25);
      background: white;
    }

    #login-submit {
      width: 100%;
      padding: 11px;
      margin-top: 16px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      background: linear-gradient(135deg, #ff6f91, #ff4081);
      color: white;
      box-shadow: 0 4px 12px rgba(255,64,129,0.55);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
      cursor: pointer;
    }

    #login-submit:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 6px 18px rgba(255,64,129,0.65);
    }

    #login-submit:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(255,64,129,0.45);
    }

    #login-error {
      color: #b71c1c;
      text-align: center;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    #app-container {
      display: none;
    }

    /* ========= APP ========= */

    header {
      background: linear-gradient(135deg, #ff6f91, #ff4081);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header small {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .tag-ubs {
      background: rgba(255,255,255,0.18);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #logout-btn {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      background: #ff7043;
      color: white;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 8px rgba(230,74,25,0.55);
      cursor: pointer;
    }

    main {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto 24px auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      border: 1px solid var(--borda);
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card h3 {
      margin: 16px 0 8px;
      font-size: 0.98rem;
      font-weight: 600;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #666;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 640px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 0.78rem;
      margin-bottom: 3px;
      color: #555;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #f48fb1;
      font-size: 0.85rem;
      font-family: inherit;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: #fffafc;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #ff4081;
      box-shadow: 0 0 0 2px rgba(255,64,129,0.18);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }

    .chip {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      align-items: center;
      gap: 6px;
      background: #ffe4f3;
      margin: 2px;
    }

    .chip input {
      margin: 0;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #ff6f91, #ff4081);
      color: white;
      box-shadow: 0 4px 10px rgba(255,64,129,0.45);
      transition: transform 0.1s, box-shadow 0.1s, background 0.15s;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(255,64,129,0.6);
    }

    .btn.secondary {
      background: #ffffff;
      color: #ff4081;
      border: 1px solid #ffb6c1;
      box-shadow: none;
    }

    .btn.secondary:hover {
      background: #ffe4f3;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    }

    .btn.sm {
      padding: 4px 10px;
      font-size: 0.78rem;
      box-shadow: none;
    }

    .small-text {
      font-size: 0.75rem;
      color: #666;
    }

    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }

    .age-box {
      font-size: 0.8rem;
      background: #fff3e0;
      padding: 6px 8px;
      border-radius: 10px;
      margin-top: 4px;
      line-height: 1.3;
      border: 1px dashed #ffb74d;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill.habitual {
      background: var(--risk-habitual);
      color: #1b5e20;
    }

    .pill.inter {
      background: var(--risk-inter);
      color: #8d6e00;
    }

    .pill.alto {
      background: var(--risk-alto);
      color: #b71c1c;
    }

    .pill.small {
      font-size: 0.68rem;
      padding: 1px 6px;
    }

    .child-list {
      max-height: 520px;
      overflow-y: auto;
      padding-right: 3px;
    }

    .child-card {
      border-radius: 12px;
      padding: 10px 9px;
      border: 1px solid #f8bbd0;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.12s, border 0.12s, transform 0.08s, box-shadow 0.12s;
      background: #fffafc;
    }

    .child-card.risco-habitual {
      border-left: 4px solid #2e7d32;
      background: #f1f8e9;
    }

    .child-card.risco-intermediario {
      border-left: 4px solid #f9a825;
      background: #fffde7;
    }

    .child-card.risco-alto {
      border-left: 4px solid #c62828;
      background: #ffebee;
    }

    .child-card:hover {
      background: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .child-card.active {
      border-color: #ff4081;
      box-shadow: 0 0 0 1px rgba(255,64,129,0.55);
      background: #ffffff;
    }

    .child-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.85rem;
      margin-bottom: 2px;
    }

    .child-name {
      font-weight: 600;
    }

    .child-meta {
      font-size: 0.75rem;
      color: #666;
    }

    .alert-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      font-size: 0.8rem;
    }

    .alert-list li {
      display: flex;
      gap: 6px;
      margin-bottom: 3px;
    }

    .alert-icon {
      font-size: 0.9rem;
    }

    .badge-vdrl {
      font-size: 0.68rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fff3cd;
      color: #8a6d3b;
      display: inline-block;
      margin-top: 3px;
    }

    .btn-icon {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0 2px;
      margin-left: 4px;
      color: #888;
    }
    .btn-icon:hover {
      color: #c62828;
    }

    .hist-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 8px;
    }

    .hist-table th,
    .hist-table td {
      border-bottom: 1px solid #eee;
      padding: 3px 4px;
      text-align: left;
    }

    .hist-table th {
      background: #ffe4f3;
    }

    /* Modal gen√©rico */

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      max-width: 960px;
      width: 96%;
      max-height: 90vh;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      padding: 16px;
      overflow: auto;
    }

    .modal h3 {
      margin-top: 0;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .close-modal {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
    }

    .info-text {
      font-size: 0.8rem;
      color: #555;
      margin-top: 6px;
    }

    @media print {
      body {
        background: #ffffff;
      }
      header, .no-print, .modal-overlay {
        display: none !important;
      }
      main {
        display: block;
        padding: 0;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: none;
        padding: 0;
      }
    }
  </style>

</head>
<body>

<!-- ========== LOGIN ========== -->
<div id="login-container">
  <h2>üçº Puericultura Dra Schwartz üë∂</h2>
  <p class="subtitle">Acesso restrito ¬∑ fa√ßa login com seu e-mail cadastrado.</p>

  <form id="login-form">
    <label for="login-email">E-mail</label>
    <input type="email" id="login-email" autocomplete="email" required>

    <label for="login-password">Senha</label>
    <input type="password" id="login-password" autocomplete="current-password" required>

    <button id="login-submit" type="submit">Entrar</button>
  </form>

  <p id="login-error" style="display:none;"></p>
</div>

<!-- ========== APLICATIVO ========== -->
<div id="app-container">
  <header class="no-print">
    <div>
      <h1>üçº PUERICULTURA DRA SCHWARTZ üë∂</h1>
      <small>Seguimento de 0 a 2 anos ¬∑ UBS ¬∑ Crian√ßa & Fam√≠lia</small>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <div class="tag-ubs">
        üë∂üçº Acompanhamento integral da crian√ßa
      </div>
      <button id="logout-btn" type="button" class="no-print">‚èè Sair</button>
    </div>
  </header>

  <main>
    <!-- FORMUL√ÅRIO / CONSULTA -->
    <section class="card">
      <h2>üß∑ Dados da crian√ßa & consulta</h2>
      <p class="subtitle">
        As informa√ß√µes ficam salvas neste computador (localStorage).  
        Use uma ficha por crian√ßa e registre as consultas no hist√≥rico. üçº
      </p>

      <input type="hidden" id="childId">

      <h3>Identifica√ß√£o</h3>
      <div class="grid-2">
        <div>
          <label for="ubsNome">UBS atendida</label>
          <input type="text" id="ubsNome" autocomplete="off" placeholder="Ex: UBS Vila Nova">
        </div>
        <div>
          <label for="nome">Nome da crian√ßa üë∂</label>
          <input type="text" id="nome" autocomplete="off">
        </div>
      </div>

      <div class="grid-2 mt-8">
        <div>
          <label for="nomeMae">Nome da m√£e / cuidador principal</label>
          <input type="text" id="nomeMae" autocomplete="off">
        </div>
        <div>
          <label for="sexo">Sexo</label>
          <select id="sexo">
            <option value="">N√£o informado</option>
            <option value="F">Feminino</option>
            <option value="M">Masculino</option>
          </select>

          <label for="viaParto" class="mt-8">Via de parto</label>
          <select id="viaParto">
            <option value="">N√£o informado</option>
            <option value="vaginal">Vaginal</option>
            <option value="cesarea">Ces√°rea</option>
            <option value="forceps">F√≥rceps / v√°cuo-extrator</option>
          </select>
        </div>
      </div>

      <div class="grid-3 mt-8">
        <div>
          <label for="dataNasc">Data de nascimento</label>
          <input type="date" id="dataNasc">
        </div>
        <div>
          <label for="igSemanas">IG ao nascer (semanas)</label>
          <input type="number" id="igSemanas" min="20" max="42" step="1" placeholder="ex: 32">
        </div>
        <div>
          <label for="pesoNascimento">Peso ao nascer (g)</label>
          <input type="number" id="pesoNascimento" min="300" max="6000" step="1" placeholder="ex: 3200">
        </div>
      </div>

      <div class="age-box mt-8" id="idadeBox">
        <strong>Idade na data da consulta:</strong>
        <div>Cronol√≥gica: ‚Äî</div>
        <div>Idade corrigida (se prematuro): ‚Äî</div>
      </div>

      <h3>Condi√ß√µes maternas & contexto familiar</h3>
      <div class="grid-2">
        <div>
          <label>Marcadores de vulnerabilidade materna/familiar</label>
          <div class="field-inline" id="condMaternasGroup">
            <label class="chip"><input type="checkbox" data-cond-mat="HAS"> HAS</label>
            <label class="chip"><input type="checkbox" data-cond-mat="DM"> DM</label>
            <label class="chip"><input type="checkbox" data-cond-mat="Depress√£o/TPM"> Depress√£o / TP grave</label>
            <label class="chip"><input type="checkbox" data-cond-mat="Uso de √°lcool/drogas"> √Ålcool/drogas</label>
            <label class="chip"><input type="checkbox" data-cond-mat="Viol√™ncia dom√©stica"> Viol√™ncia</label>
            <label class="chip"><input type="checkbox" data-cond-mat="M√£e adolescente"> M√£e adolescente</label>
            <label class="chip"><input type="checkbox" data-cond-mat="Baixa escolaridade"> Baixa escolaridade</label>
            <label class="chip"><input type="checkbox" data-cond-mat="Pouco suporte familiar"> Pouco suporte familiar</label>
          </div>
          <label for="doencasMaternas" class="mt-8">Outras doen√ßas maternas relevantes</label>
          <textarea id="doencasMaternas"
                    placeholder="Ex: cardiopatia, doen√ßa autoimune, outras..."></textarea>
        </div>
        <div>
          <label>Exposi√ß√£o / doen√ßa infectocontagiosa</label>
          <div class="field-inline">
            <label class="chip"><input type="checkbox" id="exposicaoSifilis"> S√≠filis materna / cong√™nita</label>
            <label class="chip"><input type="checkbox" id="exposicaoHiv"> HIV</label>
            <label class="chip"><input type="checkbox" id="exposicaoHep"> Hepatites</label>
            <label class="chip"><input type="checkbox" id="exposicaoOutras"> Outras (STORCH etc.)</label>
          </div>
          <label for="infectoObs" class="mt-8">Plano de seguimento / exames de controle</label>
          <textarea id="infectoObs"
                    placeholder="Ex: esquema de VDRL trimestral, sorologias seriadas, avalia√ß√µes especializadas..."></textarea>
        </div>
      </div>

      <h3>Vacinas üíâ</h3>
      <div class="grid-2">
        <div>
          <label for="sitVacinal">Situa√ß√£o vacinal</label>
          <select id="sitVacinal">
            <option value="">N√£o informada</option>
            <option value="emdia">Em dia</option>
            <option value="atrasada">Atrasada</option>
            <option value="especial">Esquema especial</option>
            <option value="naosabe">N√£o sabe / sem carteira</option>
          </select>
          <p class="small-text mt-8">
            Registrar aqui se h√° vacinas em atraso, doses agendadas ou esquema especial. üçº
          </p>
        </div>
        <div>
          <label for="vacinasObs">Vacinas / pend√™ncias importantes</label>
          <textarea id="vacinasObs"
                    placeholder="Ex: refor√ßo Pentavalente em atraso, agendar Rotav√≠rus, esquema especial para prematuro..."></textarea>
        </div>
      </div>

      <h3>Condi√ß√µes da crian√ßa</h3>
      <div class="grid-2">
        <div>
          <label>Doen√ßas / condi√ß√µes relevantes</label>
          <div class="field-inline" id="condCriancaGroup">
            <label class="chip">
              <input type="checkbox" data-cond-crianca="prematuro"> Prematuro (&lt;37s)
            </label>
            <label class="chip">
              <input type="checkbox" data-cond-crianca="sd"> S√≠ndrome de Down
            </label>
            <label class="chip">
              <input type="checkbox" data-cond-crianca="pc"> Paralisia cerebral
            </label>
            <label class="chip">
              <input type="checkbox" data-cond-crianca="malformacao"> Malforma√ß√£o importante
            </label>
            <label class="chip">
              <input type="checkbox" data-cond-crianca="doencaCronica"> Doen√ßa cr√¥nica (cardio/pulmonar/renal...)
            </label>
          </div>
        </div>
        <div>
          <label for="doencasCrianca" class="mt-8">Detalhes sobre doen√ßa/deformidade</label>
          <textarea id="doencasCrianca"
                    placeholder="Ex: cardiopatia cong√™nita, SD com hipotonia importante, malforma√ß√£o de membros, etc."></textarea>
        </div>
      </div>

      <h3>Estratifica√ß√£o de risco global</h3>
      <div class="field-inline">
        <label for="riscoGlobal">Risco atual</label>
        <select id="riscoGlobal">
          <option value="habitual">Habitual</option>
          <option value="intermediario">Intermedi√°rio</option>
          <option value="alto">Alto risco</option>
        </select>
        <span class="small-text">Rever a cada consulta conforme linha de cuidado.</span>
      </div>

      <h3>Seguimento diferenciado / exames de controle</h3>
      <div class="field-inline">
        <label class="chip">
          <input type="checkbox" id="flagAcomp">
          Necessita acompanhamento diferenciado / exames seriados
        </label>
      </div>
      <div class="mt-8">
        <label for="flagAcompObs">Descri√ß√£o do plano (exames, retornos, especialistas)</label>
        <textarea id="flagAcompObs"
                  placeholder="Ex: controle VDRL trimestral, retorno mensal, neuropediatria, fisioterapia..."></textarea>
      </div>

      <h3>Consulta atual ‚Äì dados antropom√©tricos</h3>
      <div class="grid-3">
        <div>
          <label for="dataConsulta">Data da consulta</label>
          <input type="date" id="dataConsulta">
        </div>
        <div>
          <label for="peso">Peso (kg)</label>
          <input type="number" id="peso" min="0" step="0.01" placeholder="ex: 4.350">
        </div>
        <div>
          <label for="altura">Comprimento/altura (cm)</label>
          <input type="number" id="altura" min="20" step="0.1" placeholder="ex: 54.0">
        </div>
      </div>

      <div class="grid-3 mt-8">
        <div>
          <label for="pc">Per√≠metro cef√°lico (cm)</label>
          <input type="number" id="pc" min="20" step="0.1">
        </div>
        <div>
          <label for="imc">IMC (kg/m¬≤) ‚Äì calculado</label>
          <input type="number" id="imc" readonly>
        </div>
        <div>
          <label for="obsAntropo">Observa√ß√£o antropom√©trica</label>
          <input type="text" id="obsAntropo"
                 placeholder="Ex: ganho ponderal adequado, queda de canal...">
        </div>
      </div>

      <div class="grid-3 mt-8">
        <div>
          <label for="pPeso">Percentil Peso/Idade (P)</label>
          <input type="number" id="pPeso" min="0" max="100" step="0.1" placeholder="ex: 25">
        </div>
        <div>
          <label for="pAltura">Percentil Altura/Idade (P)</label>
          <input type="number" id="pAltura" min="0" max="100" step="0.1">
        </div>
        <div>
          <label for="pPc">Percentil PC/Idade (P)</label>
          <input type="number" id="pPc" min="0" max="100" step="0.1">
        </div>
      </div>

      <div class="grid-3 mt-8">
        <div>
          <label for="pImc">Percentil IMC/Idade (P) (‚â• 2 anos)</label>
          <input type="number" id="pImc" min="0" max="100" step="0.1">
        </div>
        <div>
          <label>Estratifica√ß√£o antropom√©trica (OMS por percentil)</label>
          <div id="riscoAntropoPill" class="pill small">
            Preencha percentis para classificar.
          </div>
        </div>
      </div>

      <div class="mt-16" style="display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" class="btn" id="btnSalvar">
          üíæ Salvar crian√ßa & consulta
        </button>
        <button type="button" class="btn secondary" id="btnHistorico">
          üìú Hist√≥rico de consultas
        </button>
        <button type="button" class="btn secondary" id="btnGraficos">
          üìà Gr√°ficos
        </button>
      </div>

      <p class="small-text mt-8">
        Dica: para uma mesma crian√ßa, mantenha o mesmo cadastro e apenas v√°
        adicionando as consultas sucessivas. O hist√≥rico e os gr√°ficos s√£o
        montados automaticamente. üë∂
      </p>
    </section>

    <!-- LISTA DE CRIAN√áAS (AGORA NO FINAL DA P√ÅGINA) -->
    <section class="card">
      <h2>
        üë∂ Crian√ßas em acompanhamento
        <button type="button" class="btn sm secondary no-print" id="btnNovaCrianca">Nova crian√ßa</button>
      </h2>
      <p class="subtitle">Clique no nome para carregar dados e registrar consulta. üçº</p>

      <div class="child-list" id="childList"></div>
    </section>
  </main>
</div>

<!-- ========== MODAL HIST√ìRICO ========== -->
<div class="modal-overlay" id="modalHistorico">
  <div class="modal">
    <div class="modal-header">
      <h3>Hist√≥rico de consultas</h3>
      <button class="close-modal" data-close-modal="modalHistorico">‚úñ</button>
    </div>
    <div id="histChildInfo" class="small-text"></div>
    <table class="hist-table" id="histTable">
      <thead>
        <tr>
          <th>Data</th>
          <th>Peso (kg)</th>
          <th>Altura (cm)</th>
          <th>PC (cm)</th>
          <th>IMC</th>
          <th>Obs</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="info-text">
      Consultas ficam salvas localmente. Para atualizar uma medida, registre
      nova consulta na data desejada e considere a evolu√ß√£o nas curvas.
    </p>
  </div>
</div>

<!-- ========== MODAL GR√ÅFICOS ========== -->
<div class="modal-overlay" id="modalGraficos">
  <div class="modal">
    <div class="modal-header">
      <h3>Gr√°ficos antropom√©tricos</h3>
      <button class="close-modal" data-close-modal="modalGraficos">‚úñ</button>
    </div>
    <div id="grafChildInfo" class="small-text"></div>

    <canvas id="chartPeso" height="140"></canvas>
    <canvas id="chartAltura" height="140" style="margin-top:16px;"></canvas>
    <canvas id="chartPc" height="140" style="margin-top:16px;"></canvas>
    <canvas id="chartImc" height="140" style="margin-top:16px;"></canvas>

    <p id="grafAvisoCondicao" class="info-text"></p>
  </div>
</div>

<script>
  // ======= CONFIG FIREBASE (preencha com seu projeto) =======
  // Substitua os valores abaixo pelos dados do seu projeto Firebase.
  const firebaseConfig = {
    apiKey: "SUA_API_KEY_AQUI",
    authDomain: "SEU_PROJETO.firebaseapp.com",
    projectId: "SEU_PROJETO",
    // os campos abaixo s√£o opcionais para auth por e-mail/senha,
    // mas voc√™ pode incluir se quiser usar mais recursos:
    // storageBucket: "SEU_PROJETO.appspot.com",
    // messagingSenderId: "XXXXXXXXXXXX",
    // appId: "1:XXXXXXXXXXXX:web:YYYYYYYYYYYYYY"
  };

  firebase.initializeApp(firebaseConfig);

  // ======= LOGIN COM FIREBASE AUTH =======
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const loginContainer = document.getElementById('login-container');
  const appContainer = document.getElementById('app-container');
  const logoutBtn = document.getElementById('logout-btn');

  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      loginContainer.style.display = 'none';
      appContainer.style.display = 'block';
      carregarDoStorage();
    } else {
      appContainer.style.display = 'none';
      loginContainer.style.display = 'block';
    }
  });

  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value.trim();
    const senha = document.getElementById('login-password').value;

    loginError.style.display = 'none';

    firebase.auth().signInWithEmailAndPassword(email, senha)
      .then(() => {
        loginError.style.display = 'none';
      })
      .catch((error) => {
        loginError.textContent = error.message || 'Erro ao fazer login.';
        loginError.style.display = 'block';
      });
  });

  logoutBtn.addEventListener('click', () => {
    firebase.auth().signOut();
  });

  // ======= MODELO DE DADOS / LOCALSTORAGE =======

  const STORAGE_KEY = 'puericultura_children_v1';
  let children = [];
  let childAtivoId = null;

  function carregarDoStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      children = raw ? JSON.parse(raw) : [];
    } catch (e) {
      children = [];
    }
    renderChildrenList();
  }

  function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(children));
  }

  function gerarId() {
    return 'c_' + Math.random().toString(36).slice(2, 10);
  }

  // ======= UTILIT√ÅRIOS =======

  function calcularIdadeEmMeses(dataNasc, dataRef) {
    if (!dataNasc || !dataRef) return null;
    const dn = new Date(dataNasc);
    const dr = new Date(dataRef);
    const anos = dr.getFullYear() - dn.getFullYear();
    const meses = dr.getMonth() - dn.getMonth();
    const total = anos * 12 + meses;
    return total < 0 ? null : total;
  }

  function formatarIdadeLegivel(meses) {
    if (meses == null) return '‚Äî';
    const anos = Math.floor(meses / 12);
    const m = meses % 12;
    const partes = [];
    if (anos > 0) partes.push(anos + 'a');
    if (m > 0) partes.push(m + 'm');
    if (!partes.length) return '0m';
    return partes.join(' ');
  }

  function calcularIMC(peso, alturaCm) {
    if (!peso || !alturaCm) return null;
    const alturaM = alturaCm / 100;
    if (alturaM <= 0) return null;
    return peso / (alturaM * alturaM);
  }

  // ====== CLASSIFICA√á√ÉO ANTROPOM√âTRICA (OMS por percentil) ======

  function classificaPercentil(p) {
    if (p == null || isNaN(p)) return null;
    if (p < 3) return 'alto';           // <P3
    if (p < 15) return 'intermediario'; // P3‚ÄìP15
    if (p <= 85) return 'habitual';     // P15‚ÄìP85
    if (p <= 97) return 'intermediario';// P85‚ÄìP97
    return 'alto';                      // >P97
  }

  function combinarRiscos(riscos) {
    if (!riscos || !riscos.length) return null;
    if (riscos.includes('alto')) return 'alto';
    if (riscos.includes('intermediario')) return 'intermediario';
    return 'habitual';
  }

  function calculaRiscoAntropo(pPeso, pAltura, pPc, pImc) {
    const riscos = [];
    [pPeso, pAltura, pPc, pImc].forEach(p => {
      const r = classificaPercentil(p);
      if (r) riscos.push(r);
    });
    return combinarRiscos(riscos);
  }

  function atualizarPillAntropo() {
    const pPeso = parseFloat((document.getElementById('pPeso').value || '').replace(',', '.'));
    const pAltura = parseFloat((document.getElementById('pAltura').value || '').replace(',', '.'));
    const pPc = parseFloat((document.getElementById('pPc').value || '').replace(',', '.'));
    const pImc = parseFloat((document.getElementById('pImc').value || '').replace(',', '.'));

    const risco = calculaRiscoAntropo(
      isNaN(pPeso) ? null : pPeso,
      isNaN(pAltura) ? null : pAltura,
      isNaN(pPc) ? null : pPc,
      isNaN(pImc) ? null : pImc
    );

    const el = document.getElementById('riscoAntropoPill');
    el.className = 'pill small';

    if (!risco) {
      el.textContent = 'Preencha ao menos um percentil para classificar.';
      return;
    }

    if (risco === 'habitual') {
      el.classList.add('habitual');
      el.textContent = 'Antropometria: dentro da faixa habitual (OMS).';
    } else if (risco === 'intermediario') {
      el.classList.add('inter');
      el.textContent = 'Antropometria: aten√ß√£o / risco intermedi√°rio (OMS).';
    } else {
      el.classList.add('alto');
      el.textContent = 'Antropometria: alto risco (avaliar condutas).';
    }
  }

  ['pPeso','pAltura','pPc','pImc'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', atualizarPillAntropo);
  });

  // ======= FORMUL√ÅRIO / SALVAR CRIAN√áA & CONSULTA =======

  const btnNovaCrianca = document.getElementById('btnNovaCrianca');
  const btnSalvar = document.getElementById('btnSalvar');
  const idadeBoxEl = document.getElementById('idadeBox');
  const riscoAntropoPill = document.getElementById('riscoAntropoPill');

  btnNovaCrianca.addEventListener('click', () => {
    limparFormulario();
  });

  function limparFormulario() {
    document.getElementById('childId').value = '';
    childAtivoId = null;
    document.getElementById('ubsNome').value = '';
    document.getElementById('nome').value = '';
    document.getElementById('nomeMae').value = '';
    document.getElementById('sexo').value = '';
    document.getElementById('viaParto').value = '';
    document.getElementById('dataNasc').value = '';
    document.getElementById('igSemanas').value = '';
    document.getElementById('pesoNascimento').value = '';
    document.getElementById('doencasMaternas').value = '';
    document.getElementById('infectoObs').value = '';
    document.getElementById('riscoGlobal').value = 'habitual';
    document.getElementById('flagAcomp').checked = false;
    document.getElementById('flagAcompObs').value = '';

    document.getElementById('sitVacinal').value = '';
    document.getElementById('vacinasObs').value = '';

    document.getElementById('exposicaoSifilis').checked = false;
    document.getElementById('exposicaoHiv').checked = false;
    document.getElementById('exposicaoHep').checked = false;
    document.getElementById('exposicaoOutras').checked = false;

    document.querySelectorAll('#condMaternasGroup input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('#condCriancaGroup input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('doencasCrianca').value = '';

    // Consulta
    document.getElementById('dataConsulta').value = '';
    document.getElementById('peso').value = '';
    document.getElementById('altura').value = '';
    document.getElementById('pc').value = '';
    document.getElementById('imc').value = '';
    document.getElementById('obsAntropo').value = '';
    document.getElementById('pPeso').value = '';
    document.getElementById('pAltura').value = '';
    document.getElementById('pPc').value = '';
    document.getElementById('pImc').value = '';

    idadeBoxEl.querySelectorAll('div')[0].textContent = 'Cronol√≥gica: ‚Äî';
    idadeBoxEl.querySelectorAll('div')[1].textContent = 'Idade corrigida (se prematuro): ‚Äî';
    riscoAntropoPill.textContent = 'Preencha percentis para classificar.';
    riscoAntropoPill.className = 'pill small';
  }

  document.getElementById('peso').addEventListener('input', atualizarIMC);
  document.getElementById('altura').addEventListener('input', atualizarIMC);
  document.getElementById('dataNasc').addEventListener('change', atualizarIdadeBox);
  document.getElementById('dataConsulta').addEventListener('change', atualizarIdadeBox);
  document.getElementById('igSemanas').addEventListener('input', atualizarIdadeBox);

  function atualizarIMC() {
    const peso = parseFloat(document.getElementById('peso').value.replace(',', '.'));
    const altura = parseFloat(document.getElementById('altura').value.replace(',', '.'));
    const imc = calcularIMC(peso, altura);
    document.getElementById('imc').value = imc ? imc.toFixed(2) : '';
  }

  function atualizarIdadeBox() {
    const dataNasc = document.getElementById('dataNasc').value;
    const dataConsulta = document.getElementById('dataConsulta').value;
    const igSemanas = parseInt(document.getElementById('igSemanas').value || '0', 10);
    const mesesCron = calcularIdadeEmMeses(dataNasc, dataConsulta);
    const linhaCron = idadeBoxEl.querySelectorAll('div')[0];
    const linhaCorr = idadeBoxEl.querySelectorAll('div')[1];

    linhaCron.textContent = 'Cronol√≥gica: ' + (mesesCron == null ? '‚Äî' : formatarIdadeLegivel(mesesCron));

    let idadeCorr = '‚Äî';
    if (mesesCron != null && igSemanas > 0 && igSemanas < 37) {
      const semanasFaltantes = 40 - igSemanas;
      const mesesCorrecao = semanasFaltantes / 4;
      const corr = mesesCron - mesesCorrecao;
      idadeCorr = formatarIdadeLegivel(Math.max(0, Math.round(corr)));
    }
    linhaCorr.textContent = 'Idade corrigida (se prematuro): ' + idadeCorr;
  }

  btnSalvar.addEventListener('click', () => {
    salvarCriancaEConsulta();
  });

  function salvarCriancaEConsulta() {
    const nome = document.getElementById('nome').value.trim();
    const dataConsulta = document.getElementById('dataConsulta').value;
    if (!nome) {
      alert('Informe o nome da crian√ßa.');
      return;
    }
    if (!dataConsulta) {
      alert('Informe a data da consulta.');
      return;
    }

    const ubsNome = document.getElementById('ubsNome').value.trim();
    const nomeMae = document.getElementById('nomeMae').value.trim();
    const sexo = document.getElementById('sexo').value;
    const viaParto = document.getElementById('viaParto').value;
    const dataNasc = document.getElementById('dataNasc').value;
    const igSemanas = document.getElementById('igSemanas').value;
    const pesoNascimento = document.getElementById('pesoNascimento').value;
    const doencasMaternas = document.getElementById('doencasMaternas').value.trim();
    const infectoObs = document.getElementById('infectoObs').value.trim();
    const riscoGlobal = document.getElementById('riscoGlobal').value;
    const flagAcomp = document.getElementById('flagAcomp').checked;
    const flagAcompObs = document.getElementById('flagAcompObs').value.trim();

    const sitVacinal = document.getElementById('sitVacinal').value;
    const vacinasObs = document.getElementById('vacinasObs').value.trim();

    const exposicoes = {
      sifilis: document.getElementById('exposicaoSifilis').checked,
      hiv: document.getElementById('exposicaoHiv').checked,
      hep: document.getElementById('exposicaoHep').checked,
      outras: document.getElementById('exposicaoOutras').checked
    };

    const condMaternas = Array.from(
      document.querySelectorAll('#condMaternasGroup input[type="checkbox"]')
    ).filter(cb => cb.checked).map(cb => cb.dataset.condMat);

    const condCrianca = Array.from(
      document.querySelectorAll('#condCriancaGroup input[type="checkbox"]')
    ).filter(cb => cb.checked).map(cb => cb.dataset.condCrianca);

    const doencasCrianca = document.getElementById('doencasCrianca').value.trim();

    const peso = parseFloat(document.getElementById('peso').value.replace(',', '.'));
    const altura = parseFloat(document.getElementById('altura').value.replace(',', '.'));
    const pc = parseFloat(document.getElementById('pc').value.replace(',', '.'));
    const imc = calcularIMC(peso, altura);
    const obsAntropo = document.getElementById('obsAntropo').value.trim();
    const pPeso = document.getElementById('pPeso').value;
    const pAltura = document.getElementById('pAltura').value;
    const pPc = document.getElementById('pPc').value;
    const pImc = document.getElementById('pImc').value;

    let child;
    const idExistente = document.getElementById('childId').value;
    if (idExistente) {
      child = children.find(c => c.id === idExistente);
      if (!child) {
        child = { id: idExistente, consultas: [] };
        children.push(child);
      }
    } else {
      child = { id: gerarId(), consultas: [] };
      children.push(child);
      document.getElementById('childId').value = child.id;
    }

    // Dados de identifica√ß√£o
    child.nome = nome;
    child.ubsNome = ubsNome;
    child.nomeMae = nomeMae;
    child.sexo = sexo;
    child.viaParto = viaParto;
    child.dataNasc = dataNasc;
    child.igSemanas = igSemanas;
    child.pesoNascimento = pesoNascimento;
    child.doencasMaternas = doencasMaternas;
    child.infectoObs = infectoObs;
    child.riscoGlobal = riscoGlobal;
    child.flagAcomp = flagAcomp;
    child.flagAcompObs = flagAcompObs;
    child.condMaternas = condMaternas;
    child.exposicoes = exposicoes;
    child.condCrianca = condCrianca;
    child.doencasCrianca = doencasCrianca;
    child.sitVacinal = sitVacinal;
    child.vacinasObs = vacinasObs;

    // Consulta
    const consulta = {
      id: gerarId(),
      dataConsulta,
      peso: isNaN(peso) ? null : Number(peso.toFixed(3)),
      altura: isNaN(altura) ? null : Number(altura.toFixed(1)),
      pc: isNaN(pc) ? null : Number(pc.toFixed(1)),
      imc: imc ? Number(imc.toFixed(2)) : null,
      obsAntropo,
      pPeso: pPeso ? Number(pPeso) : null,
      pAltura: pAltura ? Number(pAltura) : null,
      pPc: pPc ? Number(pPc) : null,
      pImc: pImc ? Number(pImc) : null
    };

    child.consultas = child.consultas || [];
    child.consultas.push(consulta);
    child.consultas.sort((a, b) => (a.dataConsulta || '').localeCompare(b.dataConsulta || ''));

    childAtivoId = child.id;
    saveToStorage();
    renderChildrenList();
    alert('Dados salvos com sucesso!');
  }

  // ======= LISTA DE CRIAN√áAS =======

  const childListEl = document.getElementById('childList');

  function resumoVacinasText(child) {
    const sit = child.sitVacinal || '';
    if (!sit) return 'Vacinas: situa√ß√£o n√£o informada.';
    if (sit === 'emdia') return 'üíâ Vacinas em dia.';
    if (sit === 'atrasada') return '‚ö† Vacinas em atraso.';
    if (sit === 'especial') return 'üíâ Esquema vacinal especial.';
    if (sit === 'naosabe') return '‚ùî Vacinas: n√£o sabe / sem carteira.';
    return 'Vacinas: situa√ß√£o n√£o informada.';
  }

  function renderChildrenList() {
    childListEl.innerHTML = '';
    if (!children.length) {
      childListEl.innerHTML = '<p class="small-text">Nenhuma crian√ßa cadastrada ainda.</p>';
      return;
    }

    children.forEach(child => {
      const card = document.createElement('div');
      card.className = 'child-card';

      if (child.riscoGlobal === 'habitual') card.classList.add('risco-habitual');
      else if (child.riscoGlobal === 'intermediario') card.classList.add('risco-intermediario');
      else if (child.riscoGlobal === 'alto') card.classList.add('risco-alto');

      if (child.id === childAtivoId) card.classList.add('active');

      const header = document.createElement('div');
      header.className = 'child-card-header';

      const left = document.createElement('div');
      const right = document.createElement('div');
      right.style.textAlign = 'right';
      right.style.fontSize = '0.72rem';

      const nomeEl = document.createElement('div');
      nomeEl.className = 'child-name';
      nomeEl.textContent = child.nome || 'Sem nome';

      const metaEl = document.createElement('div');
      metaEl.className = 'child-meta';
      const metaParts = [];
      if (child.sexo) metaParts.push(child.sexo === 'M' ? 'Masculino' : 'Feminino');
      if (child.dataNasc) metaParts.push(child.dataNasc);
      if (child.ubsNome) metaParts.push(child.ubsNome);
      metaEl.textContent = metaParts.join(' ¬∑ ');

      left.appendChild(nomeEl);
      left.appendChild(metaEl);

      const riscoTag = document.createElement('div');
      riscoTag.textContent = 'Risco: ' + (child.riscoGlobal || '‚Äî');

      const vacTag = document.createElement('div');
      vacTag.textContent = resumoVacinasText(child);
      vacTag.className = 'small-text';

      right.appendChild(riscoTag);
      right.appendChild(vacTag);

      const exp = child.exposicoes || {};
      if (exp.sifilis) {
        const vdrlTag = document.createElement('div');
        vdrlTag.className = 'badge-vdrl';
        const vdrlAtrasado = verificarVdrlAtrasado(child);
        vdrlTag.textContent = vdrlAtrasado
          ? '‚ö† VDRL trimestral ‚Äì solicitar'
          : '‚úî VDRL trimestral em dia (ver plano)';
        right.appendChild(vdrlTag);
      }

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'btn-icon';
      deleteBtn.title = 'Remover crian√ßa';
      deleteBtn.textContent = 'üóë';
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removerCrianca(child.id);
      });
      right.appendChild(deleteBtn);

      header.appendChild(left);
      header.appendChild(right);
      card.appendChild(header);

      const alerts = [];
      if (child.flagAcomp) {
        alerts.push('Seguimento diferenciado: ' + (child.flagAcompObs || 'ver plano.'));
      }
      if (exp.sifilis) {
        alerts.push('S√≠filis: manter seguimento com VDRL trimestral e avalia√ß√£o cl√≠nica.');
      }
      if ((child.condCrianca || []).length) {
        alerts.push('Condi√ß√£o da crian√ßa: ' + (child.condCrianca || []).join(', '));
      }

      if (alerts.length) {
        const ul = document.createElement('ul');
        ul.className = 'alert-list';
        alerts.forEach(txt => {
          const li = document.createElement('li');
          const icon = document.createElement('span');
          icon.className = 'alert-icon';
          icon.textContent = '‚ö†';
          const span = document.createElement('span');
          span.textContent = txt;
          li.appendChild(icon);
          li.appendChild(span);
          ul.appendChild(li);
        });
        card.appendChild(ul);
      }

      card.addEventListener('click', () => {
        carregarCrianca(child.id);
      });

      childListEl.appendChild(card);
    });
  }

  function removerCrianca(id) {
    if (!confirm('Remover esta crian√ßa e todo o hist√≥rico de consultas?')) return;
    children = children.filter(c => c.id !== id);
    saveToStorage();
    if (childAtivoId === id) {
      childAtivoId = null;
      limparFormulario();
    }
    renderChildrenList();
  }

  function carregarCrianca(id) {
    const child = children.find(c => c.id === id);
    if (!child) return;
    childAtivoId = id;

    document.getElementById('childId').value = child.id;
    document.getElementById('ubsNome').value = child.ubsNome || '';
    document.getElementById('nome').value = child.nome || '';
    document.getElementById('nomeMae').value = child.nomeMae || '';
    document.getElementById('sexo').value = child.sexo || '';
    document.getElementById('viaParto').value = child.viaParto || '';
    document.getElementById('dataNasc').value = child.dataNasc || '';
    document.getElementById('igSemanas').value = child.igSemanas || '';
    document.getElementById('pesoNascimento').value = child.pesoNascimento || '';
    document.getElementById('doencasMaternas').value = child.doencasMaternas || '';
    document.getElementById('infectoObs').value = child.infectoObs || '';
    document.getElementById('riscoGlobal').value = child.riscoGlobal || 'habitual';
    document.getElementById('flagAcomp').checked = !!child.flagAcomp;
    document.getElementById('flagAcompObs').value = child.flagAcompObs || '';

    document.getElementById('sitVacinal').value = child.sitVacinal || '';
    document.getElementById('vacinasObs').value = child.vacinasObs || '';

    const exp = child.exposicoes || {};
    document.getElementById('exposicaoSifilis').checked = !!exp.sifilis;
    document.getElementById('exposicaoHiv').checked = !!exp.hiv;
    document.getElementById('exposicaoHep').checked = !!exp.hep;
    document.getElementById('exposicaoOutras').checked = !!exp.outras;

    document.querySelectorAll('#condMaternasGroup input[type="checkbox"]').forEach(cb => {
      cb.checked = (child.condMaternas || []).includes(cb.dataset.condMat);
    });

    document.querySelectorAll('#condCriancaGroup input[type="checkbox"]').forEach(cb => {
      cb.checked = (child.condCrianca || []).includes(cb.dataset.condCrianca);
    });
    document.getElementById('doencasCrianca').value = child.doencasCrianca || '';

    document.getElementById('dataConsulta').value = '';
    document.getElementById('peso').value = '';
    document.getElementById('altura').value = '';
    document.getElementById('pc').value = '';
    document.getElementById('imc').value = '';
    document.getElementById('obsAntropo').value = '';
    document.getElementById('pPeso').value = '';
    document.getElementById('pAltura').value = '';
    document.getElementById('pPc').value = '';
    document.getElementById('pImc').value = '';

    idadeBoxEl.querySelectorAll('div')[0].textContent = 'Cronol√≥gica: ‚Äî';
    idadeBoxEl.querySelectorAll('div')[1].textContent = 'Idade corrigida (se prematuro): ‚Äî';
    riscoAntropoPill.textContent = 'Preencha percentis para classificar.';
    riscoAntropoPill.className = 'pill small';

    renderChildrenList();
  }

  function verificarVdrlAtrasado(child) {
    const exp = child.exposicoes || {};
    if (!exp.sifilis) return false;
    const consultas = child.consultas || [];
    if (!consultas.length) return true;
    const ultima = consultas[consultas.length - 1];
    if (!ultima.dataConsulta) return true;
    const dUlt = new Date(ultima.dataConsulta);
    const hoje = new Date();
    const diffMs = hoje - dUlt;
    const diffDias = diffMs / (1000 * 60 * 60 * 24);
    return diffDias >= 90;
  }

  // ======= HIST√ìRICO =======

  const modalHistorico = document.getElementById('modalHistorico');
  const histTableBody = document.querySelector('#histTable tbody');
  const histChildInfo = document.getElementById('histChildInfo');
  const btnHistorico = document.getElementById('btnHistorico');

  btnHistorico.addEventListener('click', () => {
    if (!childAtivoId) {
      alert('Selecione uma crian√ßa na lista antes de abrir o hist√≥rico.');
      return;
    }
    abrirHistorico();
  });

  function abrirHistorico() {
    const child = children.find(c => c.id === childAtivoId);
    if (!child) return;

    histChildInfo.textContent =
      (child.nome || 'Sem nome') +
      (child.sexo ? ' (' + (child.sexo === 'M' ? 'M' : 'F') + ')' : '') +
      (child.dataNasc ? ' ¬∑ Nasc: ' + child.dataNasc : '');

    histTableBody.innerHTML = '';
    (child.consultas || []).forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td>' + (c.dataConsulta || '') + '</td>' +
        '<td>' + (c.peso != null ? c.peso.toFixed(3) : '') + '</td>' +
        '<td>' + (c.altura != null ? c.altura.toFixed(1) : '') + '</td>' +
        '<td>' + (c.pc != null ? c.pc.toFixed(1) : '') + '</td>' +
        '<td>' + (c.imc != null ? c.imc.toFixed(2) : '') + '</td>' +
        '<td>' + (c.obsAntropo || '') + '</td>';
      histTableBody.appendChild(tr);
    });

    modalHistorico.style.display = 'flex';
  }

  // ======= GR√ÅFICOS (Chart.js) =======

  const modalGraficos = document.getElementById('modalGraficos');
  const grafChildInfo = document.getElementById('grafChildInfo');
  const grafAvisoCondicao = document.getElementById('grafAvisoCondicao');
  const btnGraficos = document.getElementById('btnGraficos');

  let chartPeso, chartAltura, chartPc, chartImc;

  btnGraficos.addEventListener('click', () => {
    if (!childAtivoId) {
      alert('Selecione uma crian√ßa na lista antes de abrir os gr√°ficos.');
      return;
    }
    abrirGraficos();
  });

  function destruirChart(chart) {
    if (chart) chart.destroy();
  }

  function abrirGraficos() {
    const child = children.find(c => c.id === childAtivoId);
    if (!child) return;

    grafChildInfo.textContent =
      (child.nome || 'Sem nome') +
      (child.sexo ? ' (' + (child.sexo === 'M' ? 'M' : 'F') + ')' : '') +
      (child.dataNasc ? ' ¬∑ Nasc: ' + child.dataNasc : '');

    const consultas = (child.consultas || []).filter(c => c.dataConsulta);
    if (!consultas.length) {
      alert('N√£o h√° consultas registradas para montar os gr√°ficos.');
      return;
    }

    consultas.sort((a, b) => (a.dataConsulta || '').localeCompare(b.dataConsulta || ''));

    const labels = consultas.map(c => c.dataConsulta || '');
    const pesoData = consultas.map(c => c.peso);
    const alturaData = consultas.map(c => c.altura);
    const pcData = consultas.map(c => c.pc);
    const imcData = consultas.map(c => c.imc);

    const cond = child.condCrianca || [];
    const ig = parseInt(child.igSemanas || '0', 10);
    const prematuro = cond.includes('prematuro') || (!isNaN(ig) && ig > 0 && ig < 37);
    const down = cond.includes('sd');
    const doencaCronica = cond.includes('doencaCronica');

    let aviso = '';
    if (prematuro) {
      aviso += 'Prematuro: interpretar curvas com idade corrigida e, se dispon√≠vel, usar curvas para prematuros. ';
    }
    if (down) {
      aviso += 'S√≠ndrome de Down: preferir curvas espec√≠ficas para SD (ex.: gr√°ficos brasileiros at√© 36 meses). ';
    }
    if (doencaCronica) {
      aviso += 'Doen√ßa cr√¥nica: considerar impacto da condi√ß√£o de base na evolu√ß√£o ponderoestatural.';
    }
    grafAvisoCondicao.textContent = aviso;

    const ctxPeso = document.getElementById('chartPeso').getContext('2d');
    const ctxAltura = document.getElementById('chartAltura').getContext('2d');
    const ctxPc = document.getElementById('chartPc').getContext('2d');
    const ctxImc = document.getElementById('chartImc').getContext('2d');

    destruirChart(chartPeso);
    destruirChart(chartAltura);
    destruirChart(chartPc);
    destruirChart(chartImc);

    const baseConfig = {
      type: 'line',
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { title: { display: true, text: 'Data da consulta' } },
          y: { beginAtZero: false }
        }
      }
    };

    chartPeso = new Chart(ctxPeso, {
      ...baseConfig,
      data: {
        labels,
        datasets: [{
          label: 'Peso (kg)',
          data: pesoData,
          borderColor: '#ff4081',
          backgroundColor: 'rgba(255,64,129,0.25)',
          tension: 0.2,
          pointRadius: 3
        }]
      }
    });

    chartAltura = new Chart(ctxAltura, {
      ...baseConfig,
      data: {
        labels,
        datasets: [{
          label: 'Altura (cm)',
          data: alturaData,
          borderColor: '#26a69a',
          backgroundColor: 'rgba(38,166,154,0.2)',
          tension: 0.2,
          pointRadius: 3
        }]
      }
    });

    chartPc = new Chart(ctxPc, {
      ...baseConfig,
      data: {
        labels,
        datasets: [{
          label: 'Per√≠metro cef√°lico (cm)',
          data: pcData,
          borderColor: '#c2185b',
          backgroundColor: 'rgba(194,24,91,0.2)',
          tension: 0.2,
          pointRadius: 3
        }]
      }
    });

    chartImc = new Chart(ctxImc, {
      ...baseConfig,
      data: {
        labels,
        datasets: [{
          label: 'IMC (kg/m¬≤)',
          data: imcData,
          borderColor: '#ff6f00',
          backgroundColor: 'rgba(255,111,0,0.2)',
          tension: 0.2,
          pointRadius: 3
        }]
      }
    });

    modalGraficos.style.display = 'flex';
  }

  // ======= MODAIS: FECHAR =======
  document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.closeModal;
      document.getElementById(id).style.display = 'none';
    });
  });

  [modalHistorico, modalGraficos].forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // ======= FIM =======
</script>

</body>
</html>

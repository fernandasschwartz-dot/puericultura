<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PUERICULTURA DRA SCHWARTZ üçºüë∂</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr/npm/chart.js"></script>

  <style>
    :root {
      /* Tema lil√°s suave */
      --primary: #6f4aa8;
      --primary-2: #8a63c7;
      --primary-soft: #efe9fb;
      --primary-soft-2: #f6f2ff;

      --bg: #fbfaff;
      --card: #ffffff;
      --text: #2b2b2b;
      --muted: #6a6a6a;
      --border: #e3dcf3;

      --risk-habitual: #eef8f1;
      --risk-inter: #fff7e6;
      --risk-alto: #ffe9ee;

      --ok: #2e7d32;
      --warn: #f57c00;
      --bad: #c62828;

      --shadow: 0 10px 30px rgba(25, 10, 45, 0.12);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* ========== LOGIN ========== */
    #login-container {
      max-width: 420px;
      margin: 42px auto;
      padding: 24px 20px 28px;
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    #login-container h2 {
      margin: 0 0 6px;
      text-align: center;
      color: var(--primary);
      font-size: 1.55rem;
      letter-spacing: 0.5px;
      font-weight: 800;
    }

    #login-container .subtitle {
      margin: 0 0 16px;
      text-align: center;
      font-size: 0.92rem;
      color: var(--muted);
    }

    #login-container label {
      margin-top: 10px;
      display: block;
      font-size: 0.85rem;
      color: #555;
    }

    #login-container input[type="email"],
    #login-container input[type="password"] {
      width: 100%;
      padding: 10px 11px;
      border-radius: 12px;
      border: 1px solid #c6bfd8;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      background: #fafafa;
    }

    #login-container input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(111, 74, 168, 0.18);
      background: white;
    }

    #login-submit {
      width: 100%;
      padding: 11px;
      margin-top: 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: white;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.2px;
    }

    #login-error {
      margin: 12px 0 0;
      padding: 10px;
      border-radius: 12px;
      background: #ffe9ee;
      border: 1px solid #ffd0da;
      color: #8b1a2b;
      font-size: 0.9rem;
      display: none;
    }

    /* ========== APP ========== */
    #app-container { display: none; }

    header {
      padding: 16px 16px 12px;
      background: linear-gradient(135deg, var(--primary-soft), #ffffff);
      border-bottom: 1px solid var(--border);
    }

    header .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      color: var(--primary);
      font-size: 1.35rem;
      font-weight: 900;
      letter-spacing: 0.6px;
    }

    header .sub {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 2px;
    }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.1px;
      transition: transform 0.05s ease-in-out;
    }
    .btn:active { transform: translateY(1px); }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: #fff;
    }
    .btn.secondary {
      background: #f3effb;
      color: #3c2b59;
      border: 1px solid var(--border);
    }
    .btn.danger {
      background: #ffe9ee;
      color: #8b1a2b;
      border: 1px solid #ffd0da;
    }

    main {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      padding: 14px;
      max-width: 1400px;
      margin: 0 auto;
    }

    @media (max-width: 980px) {
      main { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 25px rgba(25, 10, 45, 0.06);
      padding: 14px;
    }

    .card h2 {
      margin: 0 0 10px;
      color: #33214f;
      font-size: 1.08rem;
      font-weight: 900;
    }

    .subtitle {
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.35;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

    label {
      display: block;
      font-size: 0.83rem;
      color: #4c4c4c;
      margin: 0 0 6px;
      font-weight: 700;
    }

    input, select, textarea {
      width: 100%;
      border: 1px solid #cfc7e5;
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 0.95rem;
      outline: none;
      background: #fff;
    }

    textarea { min-height: 90px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(111, 74, 168, 0.12);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--primary-soft-2);
      font-weight: 800;
      color: #3a2a58;
      font-size: 0.86rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 0.8rem;
      border: 1px solid var(--border);
    }

    .b-habitual { background: var(--risk-habitual); color: #1c5a2b; }
    .b-inter { background: var(--risk-inter); color: #7a4a00; }
    .b-alto { background: var(--risk-alto); color: #7a0016; }

    .small-text { font-size: 0.85rem; color: var(--muted); }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }

    /* Lista crian√ßas */
    .child-list { display: grid; gap: 10px; }
    .child-item {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      padding: 10px;
      display: grid;
      gap: 6px;
    }
    .child-item .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .child-item .name {
      font-weight: 900;
      color: #2f2146;
    }
    .child-item .meta { font-size: 0.84rem; color: var(--muted); }
    .child-item .actions { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }

    /* Vacinas */
    .vacinas-container {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 900px) {
      .vacinas-container { grid-template-columns: 1fr; }
    }
    .vacinas-bloco {
      border-radius: 14px;
      padding: 10px;
      background: #f6f2ff;
      border: 1px solid #dfd5f4;
    }
    .vacinas-bloco h4 {
      margin: 0 0 6px;
      font-size: 0.9rem;
      color: #3c2b59;
      font-weight: 900;
    }
    .vac-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid #e9e2fb;
      background: #fff;
      margin-bottom: 8px;
    }
    .vac-left { display: grid; gap: 3px; }
    .vac-title { font-weight: 900; color: #2f2146; font-size: 0.92rem; }
    .vac-sub { font-size: 0.82rem; color: var(--muted); }
    .vac-right { display: grid; gap: 6px; justify-items: end; }
    .tag {
      font-size: 0.72rem;
      font-weight: 900;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .tag.ok { color: #1c5a2b; background: var(--risk-habitual); }
    .tag.warn { color: #7a4a00; background: var(--risk-inter); }
    .tag.bad { color: #7a0016; background: var(--risk-alto); }

    /* Alertas */
    .alert-box {
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px;
      background: #fff;
      display: grid;
      gap: 8px;
    }
    .alert-item {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #faf8ff;
      font-size: 0.9rem;
    }
    .alert-item strong { color: #2f2146; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      max-width: 980px;
      width: 96%;
      max-height: 90vh;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      padding: 16px;
      overflow: auto;
      border: 1px solid #e7def8;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .close-modal {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      cursor: pointer;
    }

    /* PRINT */
    @media print {
      body { background: #ffffff; }
      header, .no-print, .modal-overlay { display: none !important; }
      main { display: block; padding: 0; }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: none;
        padding: 0;
      }
      .print-break { page-break-after: always; }
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login-container">
    <h2>üçº PUERICULTURA DRA SCHWARTZ üë∂</h2>
    <p class="subtitle">Acesso restrito ¬∑ fa√ßa login com seu e-mail cadastrado.</p>

    <form id="login-form">
      <label for="login-email">E-mail</label>
      <input type="email" id="login-email" autocomplete="email" required />

      <label for="login-password">Senha</label>
      <input type="password" id="login-password" autocomplete="current-password" required />

      <button id="login-submit" type="submit">Entrar</button>
    </form>

    <p id="login-error"></p>
  </div>

  <!-- APP -->
  <div id="app-container">
    <header class="no-print">
      <div class="topbar">
        <div>
          <h1>üçº PUERICULTURA DRA SCHWARTZ üë∂</h1>
          <div class="sub">Visual ‚Ä¢ pr√°tico ‚Ä¢ completo (puericultura + vacinas + triagens + alertas)</div>
        </div>
        <div class="row">
          <button class="btn secondary" id="btnPrintGeral">üñ® PDF geral</button>
          <button class="btn secondary" id="btnPrintIndividual">üßí PDF da crian√ßa</button>
          <button class="btn danger" id="btnLogout">Sair</button>
        </div>
      </div>
    </header>

    <main>
      <!-- LADO ESQUERDO: CADASTRO + LISTA -->
      <section class="card no-print">
        <h2>üß∏ Cadastro & crian√ßas</h2>
        <p class="subtitle">
          Cadastre uma crian√ßa e depois selecione na lista abaixo. O painel da direita mostra a ficha completa.
        </p>

        <div class="grid">
          <div>
            <label>Nome da crian√ßa</label>
            <input id="c_nome" placeholder="Ex.: Ana Beatriz" />
          </div>
          <div>
            <label>Sexo</label>
            <select id="c_sexo">
              <option value="">‚Äî</option>
              <option value="F">Feminino</option>
              <option value="M">Masculino</option>
            </select>
          </div>

          <div>
            <label>Data de nascimento</label>
            <input id="c_dn" type="date" />
          </div>
          <div>
            <label>Nome da m√£e / respons√°vel</label>
            <input id="c_responsavel" placeholder="Ex.: Maria Silva" />
          </div>

          <div>
            <label>Telefone</label>
            <input id="c_tel" placeholder="(xx) xxxxx-xxxx" />
          </div>
          <div>
            <label>CNS / Cart√£o SUS</label>
            <input id="c_cns" placeholder="(opcional)" />
          </div>

          <div>
            <label>Endere√ßo</label>
            <input id="c_endereco" placeholder="(opcional)" />
          </div>
          <div>
            <label>Doen√ßa pr√©via / condi√ß√£o cr√¥nica?</label>
            <input id="c_doencas_previas" placeholder="Asma, cardiopatia, etc." />
          </div>

          <div>
            <label>Idade gestacional ao nascer (semanas)</label>
            <input id="c_ig_sem" type="number" min="20" max="45" placeholder="Ex.: 39" />
          </div>
          <div>
            <label>+ dias (0‚Äì6)</label>
            <input id="c_ig_dias" type="number" min="0" max="6" placeholder="Ex.: 3" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label>Antecedentes maternos/gestacionais (intercorr√™ncias, sorologias, etc.)</label>
            <textarea id="c_antecedentes_maternos" placeholder="Ex.: s√≠filis na gesta√ß√£o tratada? HIV? HAS/DMG? tabagismo? etc."></textarea>
          </div>
        </div>

        <div class="row mt-12">
          <button class="btn primary" id="btnSalvarCrianca">üíæ Salvar / atualizar</button>
          <button class="btn secondary" id="btnNovaCrianca">‚ûï Nova</button>
          <button class="btn danger" id="btnExcluirCrianca">üóë Excluir</button>
        </div>

        <div class="mt-16">
          <h2 style="margin-bottom:8px;">üìã Crian√ßas cadastradas</h2>
          <div class="child-list" id="childList"></div>
        </div>
      </section>

      <!-- LADO DIREITO: FICHA -->
      <section class="card" id="fichaCard">
        <div class="row" style="justify-content: space-between;">
          <div class="pill" id="pillAtivo">üë∂ Nenhuma crian√ßa selecionada</div>
          <div class="row no-print">
            <button class="btn secondary" id="btnHistorico">üóÇ Hist√≥rico</button>
            <button class="btn secondary" id="btnGraficos">üìà Gr√°ficos</button>
          </div>
        </div>

        <div class="mt-12" id="fichaBody" style="display:none;">
          <!-- IDADES -->
          <div class="card" style="box-shadow:none;">
            <h2>üïí Idade & IG</h2>
            <div class="row" style="flex-wrap: wrap;">
              <span class="badge" id="b_idade_crono">Idade cronol√≥gica: ‚Äî</span>
              <span class="badge" id="b_idade_corr">Idade corrigida: ‚Äî</span>
              <span class="badge" id="b_ig">IG ao nascer: ‚Äî</span>
              <span class="badge" id="b_risco">Risco: ‚Äî</span>
            </div>
            <p class="small-text mt-8">
              A idade corrigida √© aplicada automaticamente se IG ao nascer &lt; 40 semanas.
            </p>
          </div>

          <!-- TRIAGENS NEONATAIS + TIRAGENS -->
          <div class="card mt-12" style="box-shadow:none;">
            <h2>üß™ Triagens & avalia√ß√£o neonatal</h2>

            <div class="grid">
              <div>
                <label>Teste do pezinho (data)</label>
                <input id="t_pezinho_data" type="date" />
              </div>
              <div>
                <label>Resultado</label>
                <select id="t_pezinho_res">
                  <option value="">‚Äî</option>
                  <option value="normal">Normal</option>
                  <option value="alterado">Alterado</option>
                  <option value="nao_realizado">N√£o realizado / sem laudo</option>
                </select>
              </div>

              <div>
                <label>Teste do olhinho (data)</label>
                <input id="t_olhinho_data" type="date" />
              </div>
              <div>
                <label>Resultado</label>
                <select id="t_olhinho_res">
                  <option value="">‚Äî</option>
                  <option value="normal">Normal</option>
                  <option value="alterado">Alterado</option>
                  <option value="nao_realizado">N√£o realizado / sem laudo</option>
                </select>
              </div>

              <div>
                <label>Teste da orelhinha (data)</label>
                <input id="t_orelhinha_data" type="date" />
              </div>
              <div>
                <label>Resultado</label>
                <select id="t_orelhinha_res">
                  <option value="">‚Äî</option>
                  <option value="normal">Normal</option>
                  <option value="alterado">Alterado</option>
                  <option value="nao_realizado">N√£o realizado / sem laudo</option>
                </select>
              </div>

              <div>
                <label>Teste do cora√ß√£ozinho (data)</label>
                <input id="t_coracao_data" type="date" />
              </div>
              <div>
                <label>Resultado</label>
                <select id="t_coracao_res">
                  <option value="">‚Äî</option>
                  <option value="normal">Normal</option>
                  <option value="alterado">Alterado</option>
                  <option value="nao_realizado">N√£o realizado / sem laudo</option>
                </select>
              </div>

              <div>
                <label>Tiragens neonatais (data)</label>
                <input id="t_tiragens_data" type="date" />
              </div>
              <div>
                <label>Tiragens</label>
                <select id="t_tiragens_presenca">
                  <option value="">‚Äî</option>
                  <option value="ausente">Ausente</option>
                  <option value="presente">Presente</option>
                </select>
              </div>

              <div style="grid-column: 1 / -1;">
                <label>Detalhes (tiragens / triagens alteradas / encaminhamentos)</label>
                <textarea id="t_obs" placeholder="Ex.: tiragem subcostal leve, olhinho alterado ‚Üí oftalmo..."></textarea>
              </div>
            </div>
          </div>

          <!-- ANTROPOMETRIA + CONSULTA -->
          <div class="card mt-12" style="box-shadow:none;">
            <h2>üìè Consulta atual ‚Ä¢ antropometria</h2>
            <p class="subtitle">Registre medidas, percentis (se dispon√≠veis) e observa√ß√µes da consulta.</p>

            <div class="grid">
              <div>
                <label>Data da consulta</label>
                <input id="v_data" type="date" />
              </div>
              <div>
                <label>Estratifica√ß√£o de risco (na consulta)</label>
                <select id="v_risco">
                  <option value="habitual">Habitual</option>
                  <option value="intermediario">Intermedi√°rio</option>
                  <option value="alto">Alto</option>
                </select>
              </div>

              <div>
                <label>Peso (kg)</label>
                <input id="v_peso" type="number" step="0.01" min="0" placeholder="Ex.: 8.25" />
              </div>
              <div>
                <label>Estatura (cm)</label>
                <input id="v_altura" type="number" step="0.1" min="0" placeholder="Ex.: 68.5" />
              </div>

              <div>
                <label>Per√≠metro cef√°lico (cm)</label>
                <input id="v_pc" type="number" step="0.1" min="0" placeholder="Ex.: 42.0" />
              </div>
              <div>
                <label>IMC (auto)</label>
                <input id="v_imc" disabled />
              </div>

              <div>
                <label>Percentil peso (OMS) ‚Äî se tiver</label>
                <input id="p_peso" type="number" min="0" max="100" placeholder="0‚Äì100" />
              </div>
              <div>
                <label>Percentil estatura (OMS) ‚Äî se tiver</label>
                <input id="p_altura" type="number" min="0" max="100" placeholder="0‚Äì100" />
              </div>

              <div>
                <label>Percentil PC (OMS) ‚Äî se tiver</label>
                <input id="p_pc" type="number" min="0" max="100" placeholder="0‚Äì100" />
              </div>
              <div>
                <label>Percentil IMC (OMS) ‚Äî se tiver</label>
                <input id="p_imc" type="number" min="0" max="100" placeholder="0‚Äì100" />
              </div>

              <div style="grid-column: 1 / -1;">
                <label>Observa√ß√µes cl√≠nicas (exame f√≠sico, desenvolvimento, alimenta√ß√£o, etc.)</label>
                <textarea id="v_obs" placeholder="Ex.: bom ganho ponderal, introdu√ß√£o alimentar adequada..."></textarea>
              </div>

              <div style="grid-column: 1 / -1;">
                <label>Plano / retorno (data prevista + orienta√ß√µes)</label>
                <textarea id="v_plano" placeholder="Ex.: retorno em 30 dias; refor√ßar vacinas atrasadas; solicitar exames..."></textarea>
              </div>
            </div>

            <div class="row mt-12 no-print">
              <button class="btn primary" id="btnSalvarConsulta">üíæ Salvar consulta</button>
              <button class="btn secondary" id="btnLimparConsulta">üßΩ Limpar campos</button>
            </div>

            <div class="mt-12">
              <div class="pill" id="pillAntro">üìå Classifica√ß√£o (percentil): ‚Äî</div>
            </div>
          </div>

          <!-- VACINAS -->
          <div class="card mt-12" style="box-shadow:none;">
            <h2>üíâ Vacinas (Calend√°rio Nacional) ‚Äî checklist</h2>
            <p class="subtitle">
              Marque as doses realizadas. O sistema destaca ‚ÄúATRASADA‚Äù quando a idade j√° passou.
            </p>
            <div id="vacinasWrap" class="vacinas-container"></div>
            <p class="small-text mt-8">
              * Rotav√≠rus tem janela r√≠gida; se perder o prazo, perde oportunidade (o app sinaliza).  
              * Influenza √© anual (6m a &lt;6a) e COVID-19 segue esquema vigente (registrado por doses do calend√°rio).
            </p>
          </div>

          <!-- ALERTAS -->
          <div class="card mt-12" style="box-shadow:none;">
            <h2>üö® Alertas autom√°ticos</h2>
            <div class="alert-box" id="alertBox"></div>
            <p class="small-text mt-8">
              Dicas: atrasos vacinais, triagens n√£o realizadas/alteradas, e lembretes por risco.
            </p>
          </div>

          <!-- BACKUP -->
          <div class="card mt-12 no-print" style="box-shadow:none;">
            <h2>üìÅ Backup & compartilhamento</h2>
            <p class="subtitle">
              Exporte/importa JSON. PDF √© gerado pelo navegador (Salvar como PDF).
            </p>
            <div class="row">
              <button class="btn secondary" id="btnExportJson">‚¨á Exportar JSON</button>
              <button class="btn secondary" id="btnImportJson">‚¨Ü Importar JSON</button>
              <input type="file" id="fileImportJson" accept="application/json" style="display:none;" />
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL HIST√ìRICO -->
  <div class="modal-overlay" id="modalHistorico">
    <div class="modal">
      <div class="modal-header">
        <h3>üóÇ Hist√≥rico de consultas</h3>
        <button class="close-modal" data-close-modal="modalHistorico">‚úñ</button>
      </div>
      <div id="histChildInfo" class="small-text"></div>
      <div class="mt-12" style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">Data</th>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">Peso</th>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">Altura</th>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">PC</th>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">IMC</th>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">Risco</th>
              <th style="text-align:left; padding:8px; background:#f3effb; border:1px solid var(--border);">Obs</th>
            </tr>
          </thead>
          <tbody id="histTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL GR√ÅFICOS -->
  <div class="modal-overlay" id="modalGraficos">
    <div class="modal">
      <div class="modal-header">
        <h3>üìà Gr√°ficos antropom√©tricos</h3>
        <button class="close-modal" data-close-modal="modalGraficos">‚úñ</button>
      </div>
      <div id="grafChildInfo" class="small-text"></div>

      <canvas id="chartPeso" height="140"></canvas>
      <canvas id="chartAltura" height="140" style="margin-top:16px;"></canvas>
      <canvas id="chartPc" height="140" style="margin-top:16px;"></canvas>
      <canvas id="chartImc" height="140" style="margin-top:16px;"></canvas>

      <p id="grafAvisoCondicao" class="small-text mt-8"></p>
    </div>
  </div>

  <!-- SCRIPT √öNICO -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

    // ======= FIREBASE CONFIG (MANTIDO) =======
    const firebaseConfig = {
      apiKey: "AIzaSyAg0HPhWoqbEhjybTYDfBg1AQbCbbIquaE",
      authDomain: "gerenciador-draschwartz.firebaseapp.com",
      projectId: "gerenciador-draschwartz",
      storageBucket: "gerenciador-draschwartz.firebasestorage.app",
      messagingSenderId: "283430261434",
      appId: "1:283430261434:web:4c2681d93f99c3c1382883",
      measurementId: "G-R7TE29MLKB"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);

    // ======= STORAGE =======
    const STORAGE_KEY = "puericultura_children_v2";
    let children = [];
    let childAtivoId = null;

    function carregarDoStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        children = raw ? JSON.parse(raw) : [];
      } catch {
        children = [];
      }
      renderChildrenList();
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(children));
    }

    function gerarId() {
      return "c_" + Math.random().toString(36).slice(2, 10);
    }

    function getHojeISO() {
      const d = new Date();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return d.getFullYear() + "-" + mm + "-" + dd;
    }

    // ======= IDADE / IG =======
    function calcularIdadeEmDias(dn, ref) {
      if (!dn) return null;
      const a = new Date(dn);
      const b = ref ? new Date(ref) : new Date();
      const diff = Math.floor((b - a) / (1000 * 60 * 60 * 24));
      return diff < 0 ? null : diff;
    }

    function calcularIdadeEmMeses(dn, ref) {
      if (!dn) return null;
      const dnD = new Date(dn);
      const refD = ref ? new Date(ref) : new Date();
      const anos = refD.getFullYear() - dnD.getFullYear();
      const meses = refD.getMonth() - dnD.getMonth();
      let total = anos * 12 + meses;
      if (refD.getDate() < dnD.getDate()) total -= 1;
      return total < 0 ? null : total;
    }

    function formatarIdadeLegivelMeses(m) {
      if (m == null) return "‚Äî";
      const anos = Math.floor(m / 12);
      const mm = m % 12;
      const partes = [];
      if (anos > 0) partes.push(anos + "a");
      partes.push(mm + "m");
      return partes.join(" ");
    }

    function formatarSemanasDias(dias) {
      if (dias == null) return "‚Äî";
      const s = Math.floor(dias / 7);
      const d = dias % 7;
      return s + "s " + d + "d";
    }

    function igNascimentoEmDias(child) {
      const sem = Number(child.ig_sem || 0);
      const dias = Number(child.ig_dias || 0);
      if (!sem) return null;
      return sem * 7 + dias;
    }

    function idadeCorrigidaDias(child, refISO) {
      const dn = child.dn;
      const idadeDias = calcularIdadeEmDias(dn, refISO);
      if (idadeDias == null) return null;

      const igDias = igNascimentoEmDias(child);
      if (igDias == null) return null;

      const termoDias = 40 * 7;
      if (igDias >= termoDias) return idadeDias;

      const ajuste = termoDias - igDias;
      const corr = idadeDias - ajuste;
      return corr < 0 ? 0 : corr;
    }

    // ======= IMC =======
    function calcularIMC(peso, alturaCm) {
      const p = Number(peso);
      const a = Number(alturaCm);
      if (!p || !a) return null;
      const m = a / 100;
      if (m <= 0) return null;
      return p / (m * m);
    }

    // ======= CLASSIFICA√á√ÉO (por percentil informado) =======
    function classificaPercentil(p) {
      if (p == null || isNaN(p)) return null;
      if (p < 3) return "baixo";
      if (p < 15) return "atencao";
      if (p <= 85) return "adequado";
      if (p <= 97) return "atencao";
      return "alto";
    }

    function textoClassificacao(p) {
      const c = classificaPercentil(p);
      if (!c) return "‚Äî";
      if (c === "baixo") return "‚¨á Abaixo (P<3)";
      if (c === "atencao") return "‚ö† Aten√ß√£o (P3‚Äì15 ou P85‚Äì97)";
      if (c === "adequado") return "‚úÖ Adequado (P15‚Äì85)";
      return "‚¨Ü Elevado (P>97)";
    }

    // ======= VACINAS (CALEND√ÅRIO NACIONAL - CRIAN√áA) =======
    // Regras: marca atrasada quando idade (meses) >= dueMonth e n√£o marcada.
    // Rotav√≠rus: janela r√≠gida sinalizada.
    const VAC_SCHEDULE = [
      { group: "Ao nascer", items: [
        { key: "bcg", name: "BCG", dueMonth: 0, note: "1 dose" },
        { key: "hepb_0", name: "Hepatite B", dueMonth: 0, note: "1¬™ dose" }
      ]},
      { group: "2 meses", items: [
        { key: "penta_2", name: "Penta (DTP+Hib+HB)", dueMonth: 2, note: "1¬™ dose" },
        { key: "vip_2", name: "Polio VIP", dueMonth: 2, note: "1¬™ dose" },
        { key: "pneumo10_2", name: "Pneumo 10v", dueMonth: 2, note: "1¬™ dose" },
        { key: "rota_2", name: "Rotav√≠rus", dueMonth: 2, note: "1¬™ dose (janela)" }
      ]},
      { group: "3 meses", items: [
        { key: "meningoC_3", name: "Meningo C", dueMonth: 3, note: "1¬™ dose" }
      ]},
      { group: "4 meses", items: [
        { key: "penta_4", name: "Penta (DTP+Hib+HB)", dueMonth: 4, note: "2¬™ dose" },
        { key: "vip_4", name: "Polio VIP", dueMonth: 4, note: "2¬™ dose" },
        { key: "pneumo10_4", name: "Pneumo 10v", dueMonth: 4, note: "2¬™ dose" },
        { key: "rota_4", name: "Rotav√≠rus", dueMonth: 4, note: "2¬™ dose (janela)" }
      ]},
      { group: "5 meses", items: [
        { key: "meningoC_5", name: "Meningo C", dueMonth: 5, note: "2¬™ dose" }
      ]},
      { group: "6 meses", items: [
        { key: "penta_6", name: "Penta (DTP+Hib+HB)", dueMonth: 6, note: "3¬™ dose" },
        { key: "vip_6", name: "Polio VIP", dueMonth: 6, note: "3¬™ dose" },
        { key: "influenza_6", name: "Influenza", dueMonth: 6, note: "1¬™ dose (se 1¬™ vez: 2 doses/30d)" },
        { key: "covid_6", name: "COVID-19", dueMonth: 6, note: "1¬™ dose" },
        { key: "fa_6a8", name: "Febre amarela", dueMonth: 6, note: "Dose (6‚Äì8m em casos excepcionais)" }
      ]},
      { group: "7 meses", items: [
        { key: "covid_7", name: "COVID-19", dueMonth: 7, note: "2¬™ dose" }
      ]},
      { group: "9 meses", items: [
        { key: "covid_9", name: "COVID-19", dueMonth: 9, note: "3¬™ dose" },
        { key: "fa_9", name: "Febre amarela", dueMonth: 9, note: "1 dose" }
      ]},
      { group: "12 meses", items: [
        { key: "pneumo10_12", name: "Pneumo 10v", dueMonth: 12, note: "Refor√ßo" },
        { key: "meningoACWY_12", name: "Meningo ACWY", dueMonth: 12, note: "1 dose" },
        { key: "scr_12", name: "Tr√≠plice viral (SCR)", dueMonth: 12, note: "1 dose" }
      ]},
      { group: "15 meses", items: [
        { key: "dtp_15", name: "DTP", dueMonth: 15, note: "1¬∫ refor√ßo" },
        { key: "vip_15", name: "Polio VIP", dueMonth: 15, note: "Refor√ßo" },
        { key: "scrv_15", name: "Tetraviral (SCRV)", dueMonth: 15, note: "1 dose" },
        { key: "hepa_15", name: "Hepatite A", dueMonth: 15, note: "1 dose" }
      ]},
      { group: "4 anos", items: [
        { key: "dtp_4a", name: "DTP", dueMonth: 48, note: "2¬∫ refor√ßo" },
        { key: "fa_4a", name: "Febre amarela", dueMonth: 48, note: "Refor√ßo" },
        { key: "varicela_4a", name: "Varicela", dueMonth: 48, note: "1 dose" }
      ]}
    ];

    function getChildById(id) {
      return children.find(c => c.id === id) || null;
    }

    function ensureChildDefaults(child) {
      child.vacinas = child.vacinas || {};
      child.consultas = child.consultas || [];
      child.triagens = child.triagens || {
        pezinho: { data: "", res: "", obs: "" },
        olhinho: { data: "", res: "", obs: "" },
        orelhinha: { data: "", res: "", obs: "" },
        coracao: { data: "", res: "", obs: "" },
        tiragens: { data: "", presenca: "", obs: "" },
        obs_geral: ""
      };
      return child;
    }

    // ======= RENDER LISTA =======
    const childList = document.getElementById("childList");

    function renderChildrenList() {
      childList.innerHTML = "";
      if (!children.length) {
        childList.innerHTML = '<div class="small-text">Nenhuma crian√ßa cadastrada ainda.</div>';
        return;
      }

      children
        .slice()
        .sort((a, b) => (a.nome || "").localeCompare(b.nome || ""))
        .forEach(child => {
          const idadeMeses = calcularIdadeEmMeses(child.dn, getHojeISO());
          const risco = (child.risco_atual || "habitual");
          const badgeCls = risco === "alto" ? "b-alto" : (risco === "intermediario" ? "b-inter" : "b-habitual");
          const badgeTxt = risco === "alto" ? "Alto" : (risco === "intermediario" ? "Intermedi√°rio" : "Habitual");

          const div = document.createElement("div");
          div.className = "child-item";
          div.innerHTML = `
            <div class="top">
              <div>
                <div class="name">${child.nome || "(sem nome)"}</div>
                <div class="meta">DN: ${child.dn || "‚Äî"} ¬∑ Idade: ${formatarIdadeLegivelMeses(idadeMeses)}</div>
              </div>
              <span class="badge ${badgeCls}">üß≠ ${badgeTxt}</span>
            </div>
            <div class="actions">
              <button class="btn secondary" data-open="${child.id}">üìÑ Abrir</button>
            </div>
          `;

          div.querySelector("[data-open]").addEventListener("click", () => {
            selecionarCrianca(child.id);
          });

          childList.appendChild(div);
        });
    }

    // ======= UI refs cadastro =======
    const c_nome = document.getElementById("c_nome");
    const c_sexo = document.getElementById("c_sexo");
    const c_dn = document.getElementById("c_dn");
    const c_responsavel = document.getElementById("c_responsavel");
    const c_tel = document.getElementById("c_tel");
    const c_cns = document.getElementById("c_cns");
    const c_endereco = document.getElementById("c_endereco");
    const c_doencas_previas = document.getElementById("c_doencas_previas");
    const c_ig_sem = document.getElementById("c_ig_sem");
    const c_ig_dias = document.getElementById("c_ig_dias");
    const c_antecedentes_maternos = document.getElementById("c_antecedentes_maternos");

    const btnSalvarCrianca = document.getElementById("btnSalvarCrianca");
    const btnNovaCrianca = document.getElementById("btnNovaCrianca");
    const btnExcluirCrianca = document.getElementById("btnExcluirCrianca");

    function limparFormularioCadastro() {
      c_nome.value = "";
      c_sexo.value = "";
      c_dn.value = "";
      c_responsavel.value = "";
      c_tel.value = "";
      c_cns.value = "";
      c_endereco.value = "";
      c_doencas_previas.value = "";
      c_ig_sem.value = "";
      c_ig_dias.value = "";
      c_antecedentes_maternos.value = "";
      childAtivoId = null;
      atualizarUIFicha(null);
    }

    btnNovaCrianca.addEventListener("click", () => {
      limparFormularioCadastro();
    });

    btnSalvarCrianca.addEventListener("click", () => {
      const nome = c_nome.value.trim();
      const dn = c_dn.value;
      if (!nome || !dn) {
        alert("Informe pelo menos Nome e Data de nascimento.");
        return;
      }

      if (!childAtivoId) {
        const novo = ensureChildDefaults({
          id: gerarId(),
          nome,
          sexo: c_sexo.value,
          dn,
          responsavel: c_responsavel.value.trim(),
          tel: c_tel.value.trim(),
          cns: c_cns.value.trim(),
          endereco: c_endereco.value.trim(),
          doencas_previas: c_doencas_previas.value.trim(),
          ig_sem: c_ig_sem.value,
          ig_dias: c_ig_dias.value,
          antecedentes_maternos: c_antecedentes_maternos.value.trim(),
          risco_atual: "habitual"
        });
        children.push(novo);
        childAtivoId = novo.id;
      } else {
        const c = getChildById(childAtivoId);
        if (!c) return;
        ensureChildDefaults(c);
        c.nome = nome;
        c.sexo = c_sexo.value;
        c.dn = dn;
        c.responsavel = c_responsavel.value.trim();
        c.tel = c_tel.value.trim();
        c.cns = c_cns.value.trim();
        c.endereco = c_endereco.value.trim();
        c.doencas_previas = c_doencas_previas.value.trim();
        c.ig_sem = c_ig_sem.value;
        c.ig_dias = c_ig_dias.value;
        c.antecedentes_maternos = c_antecedentes_maternos.value.trim();
      }

      saveToStorage();
      renderChildrenList();
      selecionarCrianca(childAtivoId);
      alert("Salvo!");
    });

    btnExcluirCrianca.addEventListener("click", () => {
      if (!childAtivoId) {
        alert("Selecione uma crian√ßa para excluir.");
        return;
      }
      const c = getChildById(childAtivoId);
      if (!c) return;
      if (!confirm(`Excluir "${c.nome}" e todos os dados?`)) return;
      children = children.filter(x => x.id !== childAtivoId);
      saveToStorage();
      limparFormularioCadastro();
      renderChildrenList();
    });

    // ======= SELECIONAR / ATUALIZAR FICHA =======
    const fichaBody = document.getElementById("fichaBody");
    const pillAtivo = document.getElementById("pillAtivo");
    const b_idade_crono = document.getElementById("b_idade_crono");
    const b_idade_corr = document.getElementById("b_idade_corr");
    const b_ig = document.getElementById("b_ig");
    const b_risco = document.getElementById("b_risco");

    const t_pezinho_data = document.getElementById("t_pezinho_data");
    const t_pezinho_res = document.getElementById("t_pezinho_res");
    const t_olhinho_data = document.getElementById("t_olhinho_data");
    const t_olhinho_res = document.getElementById("t_olhinho_res");
    const t_orelhinha_data = document.getElementById("t_orelhinha_data");
    const t_orelhinha_res = document.getElementById("t_orelhinha_res");
    const t_coracao_data = document.getElementById("t_coracao_data");
    const t_coracao_res = document.getElementById("t_coracao_res");
    const t_tiragens_data = document.getElementById("t_tiragens_data");
    const t_tiragens_presenca = document.getElementById("t_tiragens_presenca");
    const t_obs = document.getElementById("t_obs");

    const v_data = document.getElementById("v_data");
    const v_risco = document.getElementById("v_risco");
    const v_peso = document.getElementById("v_peso");
    const v_altura = document.getElementById("v_altura");
    const v_pc = document.getElementById("v_pc");
    const v_imc = document.getElementById("v_imc");

    const p_peso = document.getElementById("p_peso");
    const p_altura = document.getElementById("p_altura");
    const p_pc = document.getElementById("p_pc");
    const p_imc = document.getElementById("p_imc");

    const v_obs = document.getElementById("v_obs");
    const v_plano = document.getElementById("v_plano");

    const btnSalvarConsulta = document.getElementById("btnSalvarConsulta");
    const btnLimparConsulta = document.getElementById("btnLimparConsulta");

    const pillAntro = document.getElementById("pillAntro");
    const vacinasWrap = document.getElementById("vacinasWrap");
    const alertBox = document.getElementById("alertBox");

    function setBadgeRisco(el, risco) {
      el.classList.remove("b-habitual", "b-inter", "b-alto");
      if (risco === "alto") el.classList.add("b-alto");
      else if (risco === "intermediario") el.classList.add("b-inter");
      else el.classList.add("b-habitual");
    }

    function atualizarUIFicha(child) {
      if (!child) {
        fichaBody.style.display = "none";
        pillAtivo.textContent = "üë∂ Nenhuma crian√ßa selecionada";
        return;
      }
      ensureChildDefaults(child);

      fichaBody.style.display = "block";
      pillAtivo.textContent = "üë∂ " + child.nome;

      // preenche cadastro esquerdo com a crian√ßa ativa (para editar)
      c_nome.value = child.nome || "";
      c_sexo.value = child.sexo || "";
      c_dn.value = child.dn || "";
      c_responsavel.value = child.responsavel || "";
      c_tel.value = child.tel || "";
      c_cns.value = child.cns || "";
      c_endereco.value = child.endereco || "";
      c_doencas_previas.value = child.doencas_previas || "";
      c_ig_sem.value = child.ig_sem || "";
      c_ig_dias.value = child.ig_dias || "";
      c_antecedentes_maternos.value = child.antecedentes_maternos || "";

      // idades
      const ref = getHojeISO();
      const idadeMeses = calcularIdadeEmMeses(child.dn, ref);
      const idadeDias = calcularIdadeEmDias(child.dn, ref);
      const corrDias = idadeCorrigidaDias(child, ref);
      const corrMeses = corrDias == null ? null : Math.floor(corrDias / 30.4375);

      b_idade_crono.textContent = "Idade cronol√≥gica: " + (idadeDias == null ? "‚Äî" : formatarSemanasDias(idadeDias) + " (" + formatarIdadeLegivelMeses(idadeMeses) + ")");
      b_idade_corr.textContent = "Idade corrigida: " + (corrDias == null ? "‚Äî" : formatarSemanasDias(corrDias) + " (" + formatarIdadeLegivelMeses(corrMeses) + ")");
      const igDias = igNascimentoEmDias(child);
      b_ig.textContent = "IG ao nascer: " + (igDias == null ? "‚Äî" : formatarSemanasDias(igDias));

      // risco
      const risco = child.risco_atual || "habitual";
      const riscoTxt = risco === "alto" ? "Alto" : (risco === "intermediario" ? "Intermedi√°rio" : "Habitual");
      b_risco.textContent = "Risco: " + riscoTxt;
      setBadgeRisco(b_risco, risco);

      // triagens
      t_pezinho_data.value = child.triagens.pezinho.data || "";
      t_pezinho_res.value = child.triagens.pezinho.res || "";
      t_olhinho_data.value = child.triagens.olhinho.data || "";
      t_olhinho_res.value = child.triagens.olhinho.res || "";
      t_orelhinha_data.value = child.triagens.orelhinha.data || "";
      t_orelhinha_res.value = child.triagens.orelhinha.res || "";
      t_coracao_data.value = child.triagens.coracao.data || "";
      t_coracao_res.value = child.triagens.coracao.res || "";
      t_tiragens_data.value = child.triagens.tiragens.data || "";
      t_tiragens_presenca.value = child.triagens.tiragens.presenca || "";
      t_obs.value = child.triagens.obs_geral || "";

      // consulta default
      v_data.value = getHojeISO();
      v_risco.value = child.risco_atual || "habitual";
      v_peso.value = "";
      v_altura.value = "";
      v_pc.value = "";
      v_imc.value = "";
      p_peso.value = "";
      p_altura.value = "";
      p_pc.value = "";
      p_imc.value = "";
      v_obs.value = "";
      v_plano.value = "";
      pillAntro.textContent = "üìå Classifica√ß√£o (percentil): ‚Äî";

      renderVacinas(child);
      renderAlertas(child);
    }

    function selecionarCrianca(id) {
      childAtivoId = id;
      const child = getChildById(id);
      atualizarUIFicha(child);
    }

    // ======= SALVAR TRIAGENS automaticamente ao mudar =======
    const triageInputs = [
      t_pezinho_data, t_pezinho_res,
      t_olhinho_data, t_olhinho_res,
      t_orelhinha_data, t_orelhinha_res,
      t_coracao_data, t_coracao_res,
      t_tiragens_data, t_tiragens_presenca,
      t_obs
    ];

    triageInputs.forEach(el => {
      el.addEventListener("change", () => {
        const child = getChildById(childAtivoId);
        if (!child) return;
        ensureChildDefaults(child);

        child.triagens.pezinho.data = t_pezinho_data.value;
        child.triagens.pezinho.res = t_pezinho_res.value;

        child.triagens.olhinho.data = t_olhinho_data.value;
        child.triagens.olhinho.res = t_olhinho_res.value;

        child.triagens.orelhinha.data = t_orelhinha_data.value;
        child.triagens.orelhinha.res = t_orelhinha_res.value;

        child.triagens.coracao.data = t_coracao_data.value;
        child.triagens.coracao.res = t_coracao_res.value;

        child.triagens.tiragens.data = t_tiragens_data.value;
        child.triagens.tiragens.presenca = t_tiragens_presenca.value;

        child.triagens.obs_geral = t_obs.value;

        saveToStorage();
        renderAlertas(child);
      });
    });

    // ======= CONSULTA =======
    function atualizarIMCUI() {
      const imc = calcularIMC(v_peso.value, v_altura.value);
      v_imc.value = imc == null ? "" : imc.toFixed(2);
    }
    v_peso.addEventListener("input", atualizarIMCUI);
    v_altura.addEventListener("input", atualizarIMCUI);

    function atualizarClassificacaoPercentilUI() {
      const pp = Number(p_peso.value);
      const pa = Number(p_altura.value);
      const ppc = Number(p_pc.value);
      const pimc = Number(p_imc.value);

      const partes = [];
      if (p_peso.value !== "") partes.push("Peso: " + textoClassificacao(pp));
      if (p_altura.value !== "") partes.push("Estatura: " + textoClassificacao(pa));
      if (p_pc.value !== "") partes.push("PC: " + textoClassificacao(ppc));
      if (p_imc.value !== "") partes.push("IMC: " + textoClassificacao(pimc));

      pillAntro.textContent = "üìå Classifica√ß√£o (percentil): " + (partes.length ? partes.join(" ¬∑ ") : "‚Äî");
    }

    [p_peso, p_altura, p_pc, p_imc].forEach(el => el.addEventListener("input", atualizarClassificacaoPercentilUI));

    btnLimparConsulta.addEventListener("click", () => {
      v_peso.value = "";
      v_altura.value = "";
      v_pc.value = "";
      v_imc.value = "";
      p_peso.value = "";
      p_altura.value = "";
      p_pc.value = "";
      p_imc.value = "";
      v_obs.value = "";
      v_plano.value = "";
      pillAntro.textContent = "üìå Classifica√ß√£o (percentil): ‚Äî";
    });

    btnSalvarConsulta.addEventListener("click", () => {
      const child = getChildById(childAtivoId);
      if (!child) {
        alert("Selecione uma crian√ßa.");
        return;
      }
      ensureChildDefaults(child);

      const data = v_data.value || getHojeISO();
      const peso = v_peso.value ? Number(v_peso.value) : null;
      const altura = v_altura.value ? Number(v_altura.value) : null;
      const pc = v_pc.value ? Number(v_pc.value) : null;
      const imc = calcularIMC(peso, altura);

      const consulta = {
        data,
        risco: v_risco.value,
        peso,
        altura,
        pc,
        imc: imc == null ? null : Number(imc.toFixed(2)),
        percentis: {
          peso: p_peso.value ? Number(p_peso.value) : null,
          altura: p_altura.value ? Number(p_altura.value) : null,
          pc: p_pc.value ? Number(p_pc.value) : null,
          imc: p_imc.value ? Number(p_imc.value) : null
        },
        obs: v_obs.value.trim(),
        plano: v_plano.value.trim()
      };

      child.consultas.push(consulta);
      child.risco_atual = v_risco.value;

      saveToStorage();
      renderChildrenList();
      atualizarUIFicha(child);

      alert("Consulta salva!");
    });

    // ======= VACINAS UI =======
    function getVacStatus(child, item, idadeMeses, idadeDias) {
      const done = !!child.vacinas[item.key];

      // Atraso b√°sico
      const overdue = !done && idadeMeses != null && idadeMeses >= item.dueMonth;

      // Rotav√≠rus: sinaliza janela perdida (simplificado por idade em dias)
      // 1¬™ dose: at√© 11m29d; 2¬™: at√© 23m29d, intervalos - aqui apenas sinal de ‚Äúmuito tarde‚Äù
      let rotavirusLate = false;
      if (item.key.startsWith("rota_") && idadeDias != null) {
        const limiteDias = item.key === "rota_2" ? (11 * 30 + 29) : (23 * 30 + 29);
        if (!done && idadeDias > limiteDias) rotavirusLate = true;
      }

      if (done) return { tag: "ok", text: "OK" };
      if (rotavirusLate) return { tag: "bad", text: "FORA DA JANELA" };
      if (overdue) return { tag: "bad", text: "ATRASADA" };
      return { tag: "warn", text: "PENDENTE" };
    }

    function renderVacinas(child) {
      vacinasWrap.innerHTML = "";

      const idadeMeses = calcularIdadeEmMeses(child.dn, getHojeISO());
      const idadeDias = calcularIdadeEmDias(child.dn, getHojeISO());

      VAC_SCHEDULE.forEach(group => {
        const box = document.createElement("div");
        box.className = "vacinas-bloco";
        box.innerHTML = `<h4>üíâ ${group.group}</h4>`;

        group.items.forEach(item => {
          const st = getVacStatus(child, item, idadeMeses, idadeDias);

          const row = document.createElement("div");
          row.className = "vac-item";
          row.innerHTML = `
            <div class="vac-left">
              <div class="vac-title">${item.name}</div>
              <div class="vac-sub">${item.note} ¬∑ recomendado aos ${item.dueMonth}m</div>
            </div>
            <div class="vac-right">
              <span class="tag ${st.tag}">${st.text}</span>
              <label style="margin:0; font-weight:900; display:flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="checkbox" ${child.vacinas[item.key] ? "checked" : ""} />
                Feita
              </label>
            </div>
          `;

          row.querySelector("input[type=checkbox]").addEventListener("change", (e) => {
            child.vacinas[item.key] = e.target.checked;
            saveToStorage();
            renderVacinas(child);
            renderAlertas(child);
          });

          box.appendChild(row);
        });

        vacinasWrap.appendChild(box);
      });
    }

    // ======= ALERTAS =======
    function addAlert(type, title, msg) {
      const div = document.createElement("div");
      div.className = "alert-item";
      div.innerHTML = `<strong>${title}</strong><div class="small-text">${msg}</div>`;
      if (type === "bad") div.style.background = "#ffe9ee";
      if (type === "warn") div.style.background = "#fff7e6";
      if (type === "ok") div.style.background = "#eef8f1";
      alertBox.appendChild(div);
    }

    function renderAlertas(child) {
      alertBox.innerHTML = "";

      const idadeMeses = calcularIdadeEmMeses(child.dn, getHojeISO());
      const idadeDias = calcularIdadeEmDias(child.dn, getHojeISO());

      // Atrasos vacinais
      const atrasadas = [];
      VAC_SCHEDULE.forEach(g => g.items.forEach(item => {
        const st = getVacStatus(child, item, idadeMeses, idadeDias);
        if (st.text === "ATRASADA") atrasadas.push(item.name + " (" + g.group + ")");
        if (st.text === "FORA DA JANELA") atrasadas.push(item.name + " (" + g.group + " ‚Äî fora da janela)");
      }));

      if (atrasadas.length) {
        addAlert("bad", "Vacinas pendentes / atraso", atrasadas.join(" ¬∑ "));
      } else {
        addAlert("ok", "Vacinas", "Sem atraso detectado pelo calend√°rio.");
      }

      // Triagens
      const tri = child.triagens || {};
      const triList = [
        { k: "pezinho", n: "Teste do pezinho" },
        { k: "olhinho", n: "Teste do olhinho" },
        { k: "orelhinha", n: "Teste da orelhinha" },
        { k: "coracao", n: "Teste do cora√ß√£ozinho" }
      ];

      const naoRealizadas = [];
      const alteradas = [];

      triList.forEach(t => {
        const r = (tri[t.k]?.res || "");
        if (r === "alterado") alteradas.push(t.n);
        if (r === "nao_realizado" || r === "") naoRealizadas.push(t.n);
      });

      if (alteradas.length) addAlert("bad", "Triagens alteradas", alteradas.join(" ¬∑ ") + " ‚Äî considerar encaminhamento/controle.");
      if (naoRealizadas.length) addAlert("warn", "Triagens sem registro", naoRealizadas.join(" ¬∑ ") + " ‚Äî aus√™ncia j√° aumenta risco.");

      // Tiragens
      if (tri.tiragens?.presenca === "presente") {
        addAlert("bad", "Respira√ß√£o (tiragens)", "Tiragens presentes ‚Äî avaliar desconforto respirat√≥rio e necessidade de conduta/encaminhamento.");
      }

      // Risco (resumo)
      const r = child.risco_atual || "habitual";
      if (r === "alto") {
        addAlert("bad", "Estratifica√ß√£o: Alto risco", "Acompanhamento mais frequente e cuidado compartilhado quando necess√°rio.");
      } else if (r === "intermediario") {
        addAlert("warn", "Estratifica√ß√£o: Intermedi√°rio", "Ampliar calend√°rio de consultas e reestratificar se piorar.");
      } else {
        addAlert("ok", "Estratifica√ß√£o: Habitual", "Manter acompanhamento de puericultura e vacinas em dia.");
      }

      // Lembretes cl√≠nicos (baseados em texto livre da m√£e)
      const materno = (child.antecedentes_maternos || "").toLowerCase();
      if (materno.includes("s√≠filis") || materno.includes("sifilis")) {
        addAlert("warn", "Antecedente: s√≠filis na gesta√ß√£o", "Registrar acompanhamento e considerar exames de controle conforme protocolo local (ex.: VDRL/RPR seriado).");
      }
      if (materno.includes("hiv")) {
        addAlert("warn", "Antecedente: HIV materno", "Revisar esquema, profilaxias e seguimento conforme servi√ßo de refer√™ncia.");
      }
    }

    // ======= MODAIS =======
    const modalHistorico = document.getElementById("modalHistorico");
    const modalGraficos = document.getElementById("modalGraficos");
    const btnHistorico = document.getElementById("btnHistorico");
    const btnGraficos = document.getElementById("btnGraficos");

    document.querySelectorAll(".close-modal").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.closeModal;
        document.getElementById(id).style.display = "none";
      });
    });

    [modalHistorico, modalGraficos].forEach(modal => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
      });
    });

    btnHistorico.addEventListener("click", () => {
      const child = getChildById(childAtivoId);
      if (!child) return alert("Selecione uma crian√ßa.");
      ensureChildDefaults(child);

      document.getElementById("histChildInfo").textContent = child.nome + " ¬∑ DN " + (child.dn || "‚Äî");
      const tb = document.getElementById("histTbody");
      tb.innerHTML = "";

      child.consultas
        .slice()
        .sort((a, b) => (a.data || "").localeCompare(b.data || ""))
        .forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="padding:8px; border:1px solid var(--border);">${c.data || "‚Äî"}</td>
            <td style="padding:8px; border:1px solid var(--border);">${c.peso ?? "‚Äî"}</td>
            <td style="padding:8px; border:1px solid var(--border);">${c.altura ?? "‚Äî"}</td>
            <td style="padding:8px; border:1px solid var(--border);">${c.pc ?? "‚Äî"}</td>
            <td style="padding:8px; border:1px solid var(--border);">${c.imc ?? "‚Äî"}</td>
            <td style="padding:8px; border:1px solid var(--border);">${c.risco || "‚Äî"}</td>
            <td style="padding:8px; border:1px solid var(--border);">${(c.obs || "").slice(0, 120)}</td>
          `;
          tb.appendChild(tr);
        });

      modalHistorico.style.display = "flex";
    });

    // Gr√°ficos
    let chartPeso = null, chartAltura = null, chartPc = null, chartImc = null;

    function destruirChart(ch) {
      if (ch && typeof ch.destroy === "function") ch.destroy();
    }

    btnGraficos.addEventListener("click", () => {
      const child = getChildById(childAtivoId);
      if (!child) return alert("Selecione uma crian√ßa.");
      ensureChildDefaults(child);

      const consultas = child.consultas.slice().sort((a, b) => (a.data || "").localeCompare(b.data || ""));
      if (!consultas.length) {
        alert("Sem consultas registradas ainda.");
        return;
      }

      const labels = consultas.map(c => c.data || "");
      const pesoData = consultas.map(c => c.peso);
      const alturaData = consultas.map(c => c.altura);
      const pcData = consultas.map(c => c.pc);
      const imcData = consultas.map(c => c.imc);

      document.getElementById("grafChildInfo").textContent = child.nome + " ¬∑ DN " + (child.dn || "‚Äî");

      const ctxPeso = document.getElementById("chartPeso").getContext("2d");
      const ctxAltura = document.getElementById("chartAltura").getContext("2d");
      const ctxPc = document.getElementById("chartPc").getContext("2d");
      const ctxImc = document.getElementById("chartImc").getContext("2d");

      destruirChart(chartPeso);
      destruirChart(chartAltura);
      destruirChart(chartPc);
      destruirChart(chartImc);

      const baseConfig = {
        type: "line",
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: "Data" } },
            y: { beginAtZero: false }
          }
        }
      };

      chartPeso = new Chart(ctxPeso, {
        ...baseConfig,
        data: {
          labels,
          datasets: [{
            label: "Peso (kg)",
            data: pesoData,
            borderColor: "#6f4aa8",
            backgroundColor: "rgba(111,74,168,0.15)",
            tension: 0.2,
            pointRadius: 3
          }]
        }
      });

      chartAltura = new Chart(ctxAltura, {
        ...baseConfig,
        data: {
          labels,
          datasets: [{
            label: "Altura (cm)",
            data: alturaData,
            borderColor: "#8a63c7",
            backgroundColor: "rgba(138,99,199,0.15)",
            tension: 0.2,
            pointRadius: 3
          }]
        }
      });

      chartPc = new Chart(ctxPc, {
        ...baseConfig,
        data: {
          labels,
          datasets: [{
            label: "PC (cm)",
            data: pcData,
            borderColor: "#2e7d32",
            backgroundColor: "rgba(46,125,50,0.12)",
            tension: 0.2,
            pointRadius: 3
          }]
        }
      });

      chartImc = new Chart(ctxImc, {
        ...baseConfig,
        data: {
          labels,
          datasets: [{
            label: "IMC",
            data: imcData,
            borderColor: "#c62828",
            backgroundColor: "rgba(198,40,40,0.10)",
            tension: 0.2,
            pointRadius: 3
          }]
        }
      });

      document.getElementById("grafAvisoCondicao").textContent =
        "Dica: percentis OMS podem ser registrados na consulta para classificar o estado nutricional.";
      modalGraficos.style.display = "flex";
    });

    // ======= BACKUP JSON =======
    const btnExportJson = document.getElementById("btnExportJson");
    const btnImportJson = document.getElementById("btnImportJson");
    const fileImportJson = document.getElementById("fileImportJson");

    btnExportJson.addEventListener("click", () => {
      const dataStr = JSON.stringify(children, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "puericultura_draschwartz_dados.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    btnImportJson.addEventListener("click", () => {
      fileImportJson.click();
    });

    fileImportJson.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const json = JSON.parse(evt.target.result);
          if (!Array.isArray(json)) {
            alert("Arquivo JSON inv√°lido. Esperado um array de crian√ßas.");
            return;
          }
          if (!confirm("Substituir TODOS os dados atuais pelos dados do arquivo?")) return;
          children = json;
          saveToStorage();
          renderChildrenList();
          limparFormularioCadastro();
          alert("Dados importados com sucesso!");
        } catch (err) {
          console.error(err);
          alert("Erro ao ler o arquivo JSON.");
        }
      };
      reader.readAsText(file, "utf-8");
      e.target.value = "";
    });

    // ======= PRINT (GERAL / INDIVIDUAL) =======
    const btnPrintGeral = document.getElementById("btnPrintGeral");
    const btnPrintIndividual = document.getElementById("btnPrintIndividual");

    function abrirJanelaImpressao(html) {
      const w = window.open("", "_blank");
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    function renderFichaHTML(child) {
      const ref = getHojeISO();
      const idadeMeses = calcularIdadeEmMeses(child.dn, ref);
      const idadeDias = calcularIdadeEmDias(child.dn, ref);
      const corrDias = idadeCorrigidaDias(child, ref);
      const risco = child.risco_atual || "habitual";

      // vacinas atrasadas
      const atrasadas = [];
      VAC_SCHEDULE.forEach(g => g.items.forEach(item => {
        const st = getVacStatus(child, item, idadeMeses, idadeDias);
        if (st.text === "ATRASADA" || st.text === "FORA DA JANELA") atrasadas.push(item.name + " (" + st.text + ")");
      }));

      return `
        <div style="font-family: Arial, sans-serif; padding: 18px;">
          <h1 style="margin:0; color:#6f4aa8; letter-spacing:0.6px;">PUERICULTURA DRA SCHWARTZ</h1>
          <div style="color:#666; margin-top:4px;">Ficha individual ‚Ä¢ ${new Date().toLocaleDateString("pt-BR")}</div>
          <hr style="border:none; border-top:1px solid #e3dcf3; margin:14px 0;" />

          <h2 style="margin:0 0 8px; color:#2f2146;">üë∂ Identifica√ß√£o</h2>
          <div><strong>Nome:</strong> ${child.nome || "‚Äî"}</div>
          <div><strong>DN:</strong> ${child.dn || "‚Äî"} ‚Ä¢ <strong>Idade:</strong> ${idadeDias == null ? "‚Äî" : formatarSemanasDias(idadeDias)} (${formatarIdadeLegivelMeses(idadeMeses)})</div>
          <div><strong>Idade corrigida:</strong> ${corrDias == null ? "‚Äî" : formatarSemanasDias(corrDias)}</div>
          <div><strong>IG ao nascer:</strong> ${igNascimentoEmDias(child) == null ? "‚Äî" : formatarSemanasDias(igNascimentoEmDias(child))}</div>
          <div><strong>Risco:</strong> ${risco}</div>

          <h2 style="margin:14px 0 8px; color:#2f2146;">üß™ Triagens & neonatal</h2>
          <div><strong>Pezinho:</strong> ${child.triagens?.pezinho?.data || "‚Äî"} ‚Ä¢ ${child.triagens?.pezinho?.res || "‚Äî"}</div>
          <div><strong>Olhinho:</strong> ${child.triagens?.olhinho?.data || "‚Äî"} ‚Ä¢ ${child.triagens?.olhinho?.res || "‚Äî"}</div>
          <div><strong>Orelhinha:</strong> ${child.triagens?.orelhinha?.data || "‚Äî"} ‚Ä¢ ${child.triagens?.orelhinha?.res || "‚Äî"}</div>
          <div><strong>Cora√ß√£ozinho:</strong> ${child.triagens?.coracao?.data || "‚Äî"} ‚Ä¢ ${child.triagens?.coracao?.res || "‚Äî"}</div>
          <div><strong>Tiragens:</strong> ${child.triagens?.tiragens?.data || "‚Äî"} ‚Ä¢ ${child.triagens?.tiragens?.presenca || "‚Äî"}</div>
          <div style="margin-top:6px;"><strong>Obs:</strong> ${(child.triagens?.obs_geral || "").replaceAll("\n","<br/>")}</div>

          <h2 style="margin:14px 0 8px; color:#2f2146;">üíâ Vacinas</h2>
          <div><strong>Atrasos:</strong> ${atrasadas.length ? atrasadas.join(" ¬∑ ") : "Nenhum atraso detectado."}</div>

          <h2 style="margin:14px 0 8px; color:#2f2146;">üìè Hist√≥rico de consultas</h2>
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">Data</th>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">Peso</th>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">Altura</th>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">PC</th>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">IMC</th>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">Risco</th>
                <th style="border:1px solid #e3dcf3; background:#f3effb; padding:6px; text-align:left;">Obs/Plano</th>
              </tr>
            </thead>
            <tbody>
              ${
                (child.consultas || [])
                  .slice()
                  .sort((a,b)=> (a.data||"").localeCompare(b.data||""))
                  .map(c => `
                    <tr>
                      <td style="border:1px solid #e3dcf3; padding:6px;">${c.data || "‚Äî"}</td>
                      <td style="border:1px solid #e3dcf3; padding:6px;">${c.peso ?? "‚Äî"}</td>
                      <td style="border:1px solid #e3dcf3; padding:6px;">${c.altura ?? "‚Äî"}</td>
                      <td style="border:1px solid #e3dcf3; padding:6px;">${c.pc ?? "‚Äî"}</td>
                      <td style="border:1px solid #e3dcf3; padding:6px;">${c.imc ?? "‚Äî"}</td>
                      <td style="border:1px solid #e3dcf3; padding:6px;">${c.risco || "‚Äî"}</td>
                      <td style="border:1px solid #e3dcf3; padding:6px;">
                        <div><strong>Obs:</strong> ${(c.obs||"").replaceAll("\n","<br/>")}</div>
                        <div style="margin-top:4px;"><strong>Plano:</strong> ${(c.plano||"").replaceAll("\n","<br/>")}</div>
                      </td>
                    </tr>
                  `).join("")
              }
            </tbody>
          </table>

          <h2 style="margin:14px 0 8px; color:#2f2146;">üßæ Antecedentes</h2>
          <div><strong>Doen√ßas pr√©vias:</strong> ${child.doencas_previas || "‚Äî"}</div>
          <div style="margin-top:6px;"><strong>Maternos/gestacionais:</strong> ${(child.antecedentes_maternos || "‚Äî").replaceAll("\n","<br/>")}</div>

          <div style="margin-top:18px; color:#777; font-size:12px;">
            Gerado por PUERICULTURA DRA SCHWARTZ ‚Ä¢ (impress√£o do navegador)
          </div>
        </div>
      `;
    }

    btnPrintIndividual.addEventListener("click", () => {
      const child = getChildById(childAtivoId);
      if (!child) return alert("Selecione uma crian√ßa.");
      ensureChildDefaults(child);

      const html = `
        <html><head><meta charset="utf-8"><title>Ficha</title></head>
        <body>${renderFichaHTML(child)}</body></html>
      `;
      abrirJanelaImpressao(html);
    });

    btnPrintGeral.addEventListener("click", () => {
      if (!children.length) return alert("Nenhuma crian√ßa cadastrada.");
      const htmlFichas = children
        .slice()
        .sort((a,b)=> (a.nome||"").localeCompare(b.nome||""))
        .map((c, idx) => {
          ensureChildDefaults(c);
          return renderFichaHTML(c) + (idx < children.length - 1 ? '<div class="print-break"></div>' : '');
        })
        .join("");

      const html = `
        <html>
          <head>
            <meta charset="utf-8">
            <title>Relat√≥rio geral</title>
            <style>@media print{.print-break{page-break-after:always;}}</style>
          </head>
          <body>${htmlFichas}</body>
        </html>
      `;
      abrirJanelaImpressao(html);
    });

    // ======= LOGIN =======
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const loginContainer = document.getElementById("login-container");
    const appContainer = document.getElementById("app-container");
    const btnLogout = document.getElementById("btnLogout");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.style.display = "none";
      const email = document.getElementById("login-email").value.trim();
      const pass = document.getElementById("login-password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        loginError.textContent = "Erro no login: " + (err?.message || "verifique e-mail/senha.");
        loginError.style.display = "block";
      }
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginContainer.style.display = "none";
        appContainer.style.display = "block";
        carregarDoStorage();
      } else {
        appContainer.style.display = "none";
        loginContainer.style.display = "block";
      }
    });

    // boot
    v_data.value = getHojeISO();
  </script>
</body>
</html>
